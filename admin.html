<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beheer - Straatambassadeurs</title>
    <link rel="stylesheet" href="styles.css?v=20260718a">
    <meta name="theme-color" content="#1a2744">
    <link rel="icon" href="favicon.png">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-card" style="max-width: 380px;">
            <img src="images/logo-header-new.png" alt="Straatambassadeurs" style="width: 200px; height: auto; margin-bottom: 20px;">
            <h1 style="font-size: 1.2rem; margin-bottom: 4px;">ğŸ” Beheer Kerngroep</h1>
            <p style="color: var(--gray-500); margin-bottom: 20px; font-size: 0.85rem;">Alleen toegankelijk voor leden van de kerngroep.<br>Selecteer je naam en voer je PIN in.</p>
            
            <div id="login-error" class="login-error hidden">Onjuiste pincode</div>
            
            <div id="login-form">
                <div class="form-group" style="margin-bottom: 12px;">
                    <label style="font-size: 0.82rem; font-weight: 600; margin-bottom: 4px; display: block;">Naam</label>
                    <select id="login-naam" style="width: 100%; padding: 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.9rem; background: #fff;">
                        <option value="">Laden...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label style="font-size: 0.82rem; font-weight: 600; margin-bottom: 4px; display: block;">PIN code (5 cijfers)</label>
                    <input type="password" id="pin" maxlength="5" inputmode="numeric" pattern="[0-9]*" placeholder="â€¢â€¢â€¢â€¢â€¢" autocomplete="off"
                           onkeydown="if(event.key==='Enter')doLogin()">
                </div>
                <button type="button" class="btn btn-primary btn-full" onclick="doLogin()">Inloggen</button>
                <div style="text-align: center; margin-top: 12px;">
                    <a href="#" onclick="showPinVergetenModal(); return false;" style="color: var(--gray-500); text-decoration: none; font-size: 0.82rem;">ğŸ”‘ PIN vergeten?</a>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                <a href="index.html" style="color: var(--street-blue); text-decoration: none; font-size: 0.9rem; font-weight: 600;">â† Terug naar de website</a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden">
        <div class="container">
            <div id="admin-topbar" style="background: var(--night-blue); padding: 8px 16px; border-radius: var(--radius-lg); margin-bottom: var(--space-sm); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <img src="images/logo-square.png" alt="" style="width: 28px; height: 28px; border-radius: 5px;" class="admin-logo-desktop">
                    <div>
                        <span style="color: var(--accent-gold); font-weight: 700; font-size: 0.85rem;">ğŸ” Beheer</span>
                        <span id="admin-user-label" style="color: rgba(255,255,255,0.5); font-size: 0.7rem; margin-left: 6px;"></span>
                    </div>
                </div>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <a href="index.html" style="color: rgba(255,255,255,0.6); text-decoration: none; font-size: 0.75rem; padding: 4px 8px; border: 1px solid rgba(255,255,255,0.15); border-radius: 5px;">â†</a>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.15); padding: 4px 8px; border-radius: 5px; font-size: 0.72rem; cursor: pointer;">Uit</button>
                </div>
            </div>

            <main>
                <!-- Stats (compact row on mobile) -->
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card stat-nieuw">
                        <div class="stat-number" id="stat-nieuw">0</div>
                        <div class="stat-label">Nieuw</div>
                    </div>
                    <div class="stat-card stat-behandeling">
                        <div class="stat-number" id="stat-behandeling">0</div>
                        <div class="stat-label">Behandeling</div>
                    </div>
                    <div class="stat-card stat-uitgekeerd">
                        <div class="stat-number" id="stat-uitgekeerd">0</div>
                        <div class="stat-label">Uitgekeerd</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-ambassadeurs">0</div>
                        <div class="stat-label">Ambass.</div>
                    </div>
                </div>

                <!-- Quick Links (compact on mobile) -->
                <div class="admin-quicklinks" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;">
                    <a href="handleiding-kerngroep.html" target="_blank" class="ql-btn" style="background:#6b7280;">ğŸ“– <span class="ql-label">Handleiding</span></a>
                    <a href="https://kerngroep.netlify.app" target="_blank" class="ql-btn" style="background:#1e5799;">ğŸ“… <span class="ql-label">Planner</span></a>
                    <a href="https://outlook.live.com/mail/0/" target="_blank" class="ql-btn" style="background:#0078d4;">ğŸ“§ <span class="ql-label">Outlook</span></a>
                    <a href="https://onedrive.live.com" target="_blank" class="ql-btn" style="background:#094ab2;">ğŸ“ <span class="ql-label">OneDrive</span></a>
                    <button onclick="exportBackup()" class="ql-btn" style="background:#059669;border:none;cursor:pointer;">ğŸ’¾ <span class="ql-label">Backup</span></button>
                </div>

                <!-- Tabs -->
                <div class="tab-nav" id="admin-tab-nav">
                    <button class="tab-btn active" onclick="showTab('aanvragen')">ğŸ“‹ Aanvragen</button>
                    <button class="tab-btn" onclick="showTab('ambassadeurs')">ğŸ‘¥ Ambassadeurs</button>
                    <button class="tab-btn" onclick="showTab('aanmeldingen')">ğŸ™‹ Aanmeldingen</button>
                    <button class="tab-btn" onclick="showTab('afrekeningen')">ğŸ§¾ Afrekeningen</button>
                    <button class="tab-btn" onclick="showTab('potjes')">ğŸ’° Potjes</button>
                    <button class="tab-btn" onclick="showTab('financien')">ğŸ’¶ FinanciÃ«n</button>
                    <button class="tab-btn" onclick="showTab('notulen')">ğŸ“ Notulen</button>
                    <button class="tab-btn" onclick="showTab('nieuws')">ğŸ“° Nieuws</button>
                    <button class="tab-btn" onclick="showTab('nieuwsbrief')">ğŸ“§ Nieuwsbrief</button>
                    <button class="tab-btn" onclick="showTab('avg')">ğŸ”’ AVG</button>
                    <button class="tab-btn" onclick="showTab('contact')">ğŸ“¬ Contact</button>
                </div>

                <!-- Tab: Aanvragen -->
                <div id="tab-aanvragen" class="tab-content active">
                    <div class="filter-section">
                        <button onclick="openHandmatigeAanvraagModal()" style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;border-radius:6px;font-size:0.82rem;font-weight:600;background:#16a34a;color:#fff;border:none;cursor:pointer;">â• Handmatige aanvraag</button>
                        <select id="filter-status" onchange="filterAanvragen()">
                            <option value="">Alle statussen</option>
                            <option value="nieuw">Nieuw</option>
                            <option value="in_behandeling">In behandeling</option>
                            <option value="info_gevraagd">Info gevraagd</option>
                            <option value="uitgekeerd">Uitgekeerd</option>
                            <option value="afgewezen">Afgewezen</option>
                        </select>
                        <input type="text" id="filter-search" placeholder="Zoeken..." oninput="filterAanvragen()">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Ambassadeur</th>
                                    <th>Straat</th>
                                    <th>Doel</th>
                                    <th>Status</th>
                                    <th>Acties</th>
                                </tr>
                            </thead>
                            <tbody id="aanvragen-tbody">
                                <tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Laden...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Ambassadeurs -->
                <div id="tab-ambassadeurs" class="tab-content">
                    <div class="add-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label>Naam *</label>
                            <input type="text" id="new-amb-naam" placeholder="Volledige naam">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Straat *</label>
                            <input type="text" id="new-amb-straat" placeholder="Straatnaam">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Huisnummer</label>
                            <input type="text" id="new-amb-huisnummer" placeholder="Nr.">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Telefoon</label>
                            <input type="text" id="new-amb-telefoon" placeholder="06-12345678">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Email</label>
                            <input type="email" id="new-amb-email" placeholder="email@voorbeeld.nl">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Opmerkingen</label>
                            <input type="text" id="new-amb-opmerkingen" placeholder="Evt. opmerkingen">
                        </div>
                        <div class="form-group" style="margin: 0; display: flex; align-items: flex-end;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; cursor: pointer; padding: 8px 0;">
                                <input type="checkbox" id="new-amb-kerngroep-bezoek"> Kerngroep bezoek?
                            </label>
                        </div>
                        <div class="form-group" style="margin: 0; display: flex; align-items: flex-end;">
                            <button onclick="addAmbassadeur()" class="btn btn-gold" style="width: 100%;">+ Toevoegen</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Naam</th>
                                    <th>Straat</th>
                                    <th>Huisnr</th>
                                    <th>Telefoon</th>
                                    <th>Email</th>
                                    <th>Kerngroep</th>
                                    <th>Actief</th>
                                    <th>Acties</th>
                                </tr>
                            </thead>
                            <tbody id="ambassadeurs-tbody">
                                <tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Laden...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Aanmeldingen -->
                <div id="tab-aanmeldingen" class="tab-content">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Naam</th>
                                    <th>Straat</th>
                                    <th>Telefoon</th>
                                    <th>Status</th>
                                    <th>Acties</th>
                                </tr>
                            </thead>
                            <tbody id="aanmeldingen-tbody">
                                <tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Laden...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Potjes -->
                <!-- Tab: Afrekeningen -->
                <div id="tab-afrekeningen" class="tab-content">
                    <div class="table-responsive">
                        <table class="data-table" id="afrekeningen-table">
                            <thead><tr>
                                <th>Naam</th><th>Straat</th><th>Totaal</th><th>Keuze</th><th>Status</th><th>Datum</th><th>Acties</th>
                            </tr></thead>
                            <tbody id="afrekeningen-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-potjes" class="tab-content">
                    <div id="potjes-error" class="hidden" style="padding: 24px; text-align: center; background: #fef3c7; border-radius: var(--radius-md); margin-bottom: 16px;">
                        <p style="font-size: 0.9rem; color: #92400e; margin-bottom: 8px;">âš ï¸ Potjes tabellen nog niet aangemaakt</p>
                        <p style="font-size: 0.78rem; color: #78350f;">Voer de SQL migration uit: <code>supabase-migration-002-potjes.sql</code></p>
                    </div>
                    <div id="potjes-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                            <h3 style="margin: 0; font-size: 1rem; color: var(--night-blue);">ğŸ’° Potjes Overzicht</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="potjes-jaar" onchange="loadPotjes()" style="padding: 6px 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem;">
                                </select>
                            </div>
                        </div>

                        <!-- Summary stats -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
                            <div class="stat-card" style="border-color: var(--status-goedgekeurd);">
                                <div class="stat-number" id="potjes-totaal-budget" style="color: var(--status-goedgekeurd); font-size: 1.2rem;">â‚¬0</div>
                                <div class="stat-label">Totaal budget</div>
                            </div>
                            <div class="stat-card" style="border-color: var(--status-behandeling);">
                                <div class="stat-number" id="potjes-totaal-besteed" style="color: var(--status-behandeling); font-size: 1.2rem;">â‚¬0</div>
                                <div class="stat-label">Besteed</div>
                            </div>
                            <div class="stat-card" style="border-color: var(--status-nieuw);">
                                <div class="stat-number" id="potjes-totaal-resterend" style="color: var(--status-nieuw); font-size: 1.2rem;">â‚¬0</div>
                                <div class="stat-label">Resterend</div>
                            </div>
                        </div>

                        <!-- Per ambassadeur overview -->
                        <div class="info-section" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 8px;">Per ambassadeur</h3>
                            <div id="potjes-per-ambassadeur">
                                <p style="text-align: center; color: var(--gray-400); padding: 12px;">Laden...</p>
                            </div>
                        </div>

                        <!-- Add expense form -->
                        <div class="info-section" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 12px;">â• Uitgave toevoegen</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 0.78rem;">Ambassadeur</label>
                                    <select id="potje-ambassadeur" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                        <option value="">Kies ambassadeur...</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 0.78rem;">Bedrag (â‚¬)</label>
                                    <input type="number" id="potje-bedrag" step="0.01" min="0" placeholder="0.00" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 0.78rem;">Omschrijving</label>
                                    <input type="text" id="potje-omschrijving" placeholder="Waarvoor..." style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 0.78rem;">Datum</label>
                                    <input type="date" id="potje-datum" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                </div>
                            </div>
                            <button onclick="addUitgave()" class="btn btn-gold btn-small" style="margin-top: 8px;">ğŸ’° Uitgave opslaan</button>
                        </div>

                        <!-- All expenses table -->
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Datum</th>
                                        <th>Ambassadeur</th>
                                        <th>Omschrijving</th>
                                        <th>Bedrag</th>
                                        <th>Acties</th>
                                    </tr>
                                </thead>
                                <tbody id="potjes-uitgaven-tbody">
                                    <tr><td colspan="5" style="text-align: center; padding: 24px; color: var(--gray-400);">Laden...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab: Nieuws -->
                <div id="tab-nieuws" class="tab-content">
                    <div class="info-section" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 8px;">ğŸ“° Nieuws beheer</h3>
                        <p style="font-size: 0.85rem; color: var(--gray-500);">Beheer nieuwsberichten op de website. Gepubliceerde artikelen zijn zichtbaar op de nieuws pagina.</p>
                    </div>

                    <!-- Add/Edit form -->
                    <div class="info-section" id="nieuws-form-section" style="margin-bottom: 16px;">
                        <h3 id="nieuws-form-title" style="margin-bottom: 12px;">â• Nieuw artikel</h3>
                        <input type="hidden" id="nieuws-edit-id" value="">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Titel *</label>
                                <input type="text" id="nieuws-titel" placeholder="Titel van het artikel" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Samenvatting (kort, optioneel)</label>
                                <input type="text" id="nieuws-samenvatting" placeholder="Korte samenvatting voor op de kaart..." style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Inhoud * (volledig artikel)</label>
                                <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap;">
                                    <button type="button" onclick="insertFormat('**','**')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);font-weight:700;">B</button>
                                    <button type="button" onclick="insertFormat('_','_')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);font-style:italic;">I</button>
                                    <button type="button" onclick="insertFormat('## ','')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);">H2</button>
                                    <button type="button" onclick="insertFormat('### ','')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);">H3</button>
                                    <button type="button" onclick="insertFormat('â€¢ ','')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);">â€¢ Lijst</button>
                                    <button type="button" onclick="insertFormat('[link](',')')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);">ğŸ”— Link</button>
                                    <button type="button" onclick="insertFormat('ğŸ“‹ ','','block')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);">ğŸ“‹ Info</button>
                                    <button type="button" onclick="insertFormat('ğŸ“… ','','block')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);">ğŸ“… Datum</button>
                                    <button type="button" onclick="insertFormat('ğŸ“ ','','block')" class="btn btn-small" style="padding:3px 8px;font-size:0.72rem;background:var(--gray-100);color:var(--gray-700);">ğŸ“ Locatie</button>
                                </div>
                                <textarea id="nieuws-inhoud" rows="8" placeholder="Schrijf hier het volledige artikel...&#10;&#10;Opmaakcodes:&#10;**vet** â†’ vet&#10;_cursief_ â†’ cursief&#10;## Kop 2 / ### Kop 3&#10;â€¢ Opsomming&#10;[tekst](url) â†’ link&#10;ğŸ“‹ ğŸ“… ğŸ“ â†’ info/datum/locatie&#10;&#10;Dubbele enter = nieuwe alinea" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%; resize: vertical; line-height: 1.4; font-family: 'JetBrains Mono', monospace, inherit;"></textarea>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Afbeelding URL (optioneel)</label>
                                <input type="url" id="nieuws-afbeelding" placeholder="https://..." oninput="previewNieuwsImage()" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Auteur</label>
                                <input type="text" id="nieuws-auteur" placeholder="Kerngroep" value="Kerngroep" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                        </div>
                        <!-- Image preview -->
                        <div id="nieuws-image-preview" style="display: none; margin-top: 8px;">
                            <img id="nieuws-image-preview-img" src="" alt="Preview" style="max-width: 200px; max-height: 120px; object-fit: cover; border-radius: var(--radius-sm); border: 1px solid var(--gray-200);">
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 0.82rem; cursor: pointer;">
                                <input type="checkbox" id="nieuws-gepubliceerd"> Gepubliceerd (zichtbaar op website)
                            </label>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button onclick="saveNieuws()" class="btn btn-gold btn-small">ğŸ’¾ Opslaan</button>
                            <button onclick="resetNieuwsForm()" class="btn btn-secondary btn-small" id="nieuws-cancel-btn" style="display: none;">Annuleren</button>
                        </div>
                    </div>

                    <!-- Nieuws list -->
                    <div id="nieuws-list">
                        <p style="text-align: center; color: var(--gray-400); padding: 12px;">Laden...</p>
                    </div>
                </div>

                <!-- Tab: FinanciÃ«n -->
                <div id="tab-financien" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                        <h3 style="margin: 0; font-size: 1rem; color: var(--night-blue);">ğŸ’¶ Financieel Overzicht</h3>
                        <select id="financien-jaar" onchange="loadFinancien()" style="padding: 6px 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem;"></select>
                    </div>

                    <!-- Summary -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
                        <div class="stat-card" style="border-color: #10b981;">
                            <div class="stat-number" id="fin-totaal-inkomsten" style="color: #10b981; font-size: 1.2rem;">â‚¬0</div>
                            <div class="stat-label">Inkomsten</div>
                        </div>
                        <div class="stat-card" style="border-color: #ef4444;">
                            <div class="stat-number" id="fin-totaal-uitgaven" style="color: #ef4444; font-size: 1.2rem;">â‚¬0</div>
                            <div class="stat-label">Uitgaven</div>
                        </div>
                        <div class="stat-card" style="border-color: #6366f1;">
                            <div class="stat-number" id="fin-saldo" style="color: #6366f1; font-size: 1.2rem;">â‚¬0</div>
                            <div class="stat-label">Saldo</div>
                        </div>
                    </div>

                    <!-- Add form -->
                    <div class="info-section" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px;">â• Regel toevoegen</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Type *</label>
                                <select id="fin-type" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                    <option value="inkomst">ğŸ’š Inkomst</option>
                                    <option value="uitgave">ğŸ”´ Uitgave</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Categorie *</label>
                                <select id="fin-categorie" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                    <optgroup label="Inkomsten">
                                        <option value="Subsidie">Subsidie</option>
                                        <option value="Donatie">Donatie</option>
                                        <option value="Overige inkomsten">Overige inkomsten</option>
                                    </optgroup>
                                    <optgroup label="Uitgaven">
                                        <option value="Potje-uitgaven">Potje-uitgaven</option>
                                        <option value="Taartenactie">Taartenactie</option>
                                        <option value="Promotie">Promotie</option>
                                        <option value="Bijeenkomsten">Bijeenkomsten</option>
                                        <option value="Overige uitgaven">Overige uitgaven</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Kostenplaats *</label>
                                <select id="fin-kostenplaats" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                    <option value="10">10 Â· Inbreng Gerry &lt;2025</option>
                                    <option value="20">20 Â· Stichting SME VHV 1e helft 2025</option>
                                    <option value="30">30 Â· Subsidie SPM Dijkstra 2e helft 2025</option>
                                    <option value="31" selected>31 Â· Subsidie SPM Dijkstra 2026</option>
                                    <option value="90">90 Â· Overig</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Bedrag (â‚¬) *</label>
                                <input type="number" id="fin-bedrag" step="0.01" min="0" placeholder="0.00" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Datum *</label>
                                <input type="date" id="fin-datum" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Omschrijving</label>
                                <input type="text" id="fin-omschrijving" placeholder="Bijv. Subsidie gemeente Amersfoort Q1" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Bijlage (factuur/bon)</label>
                                <input type="file" id="fin-bijlage" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="padding: 6px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                        </div>
                        <button onclick="addFinancien()" class="btn btn-gold btn-small" style="margin-top: 8px;">ğŸ’¶ Opslaan</button>
                    </div>

                    <!-- Inkomsten sectie -->
                    <div class="info-section" style="margin-bottom: 12px;">
                        <h3 style="margin-bottom: 8px; color: #10b981;">ğŸ’š Inkomsten</h3>
                        <div id="fin-inkomsten-list"><p style="text-align: center; color: var(--gray-400); padding: 8px; font-size: 0.82rem;">Laden...</p></div>
                    </div>

                    <!-- Uitgaven sectie -->
                    <div class="info-section" style="margin-bottom: 12px;">
                        <h3 style="margin-bottom: 8px; color: #ef4444;">ğŸ”´ Uitgaven</h3>
                        <div id="fin-uitgaven-list"><p style="text-align: center; color: var(--gray-400); padding: 8px; font-size: 0.82rem;">Laden...</p></div>
                    </div>

                    <!-- Kostenplaatsen overzicht -->
                    <div class="info-section" style="margin-bottom: 12px;">
                        <h3 style="margin-bottom: 8px; color: #6366f1;">ğŸ“Š Overzicht per Kostenplaats</h3>
                        <div id="fin-kpl-overzicht"><p style="text-align: center; color: var(--gray-400); padding: 8px; font-size: 0.82rem;">Laden...</p></div>
                    </div>
                </div>

                <!-- Tab: Notulen -->
                <div id="tab-notulen" class="tab-content">
                    <div class="info-section" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 8px;">ğŸ“ Notulen Kerngroep Vergaderingen</h3>
                        <p style="font-size: 0.85rem; color: var(--gray-500);">Verslagen van de kerngroep bijeenkomsten. Alleen zichtbaar voor ingelogde beheerders.</p>
                    </div>

                    <!-- Upload form -->
                    <div class="info-section" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px;">â• Notulen toevoegen</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Titel</label>
                                <input type="text" id="notulen-titel" placeholder="Bijv. Kerngroep overleg" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Datum</label>
                                <input type="date" id="notulen-datum" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Aanwezigen</label>
                                <input type="text" id="notulen-aanwezig" placeholder="Frank, Carien, Stefan, ..." style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">PDF uploaden (optioneel)</label>
                                <input type="file" id="notulen-file" accept=".pdf,.doc,.docx" style="padding: 6px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                <span style="font-size: 0.7rem; color: var(--gray-400);">Of voer handmatig een URL in:</span>
                                <input type="text" id="notulen-bestand" placeholder="docs/bestandsnaam.pdf" style="padding: 6px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%; margin-top: 4px;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Samenvatting (optioneel)</label>
                                <textarea id="notulen-samenvatting" rows="2" placeholder="Korte samenvatting van de vergadering..." style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%; resize: vertical;"></textarea>
                            </div>
                        </div>
                        <button onclick="addNotulen()" class="btn btn-gold btn-small" style="margin-top: 8px;">ğŸ“ Notulen opslaan</button>
                    </div>

                    <!-- Notulen list (dynamic from Supabase + static fallback) -->
                    <div id="notulen-list">
                        <p style="text-align: center; color: var(--gray-400); padding: 12px;">Laden...</p>
                    </div>

                    <!-- Static fallback: existing PDF in docs/ folder -->
                    <div id="notulen-static" class="info-section" style="margin-top: 12px; background: var(--gray-100);">
                        <h3 style="font-size: 0.85rem; margin-bottom: 8px;">ğŸ“ Bestanden in docs/ map</h3>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <strong style="font-size: 0.82rem;">ğŸ“„ notulen-kerngroep.pdf</strong><br>
                                <span style="font-size: 0.75rem; color: var(--gray-500);">Origineel bestand</span>
                            </div>
                            <a href="docs/notulen-kerngroep.pdf" target="_blank" class="btn btn-secondary btn-small" download>â¬‡ï¸ Download</a>
                        </div>
                    </div>
                </div>
                <!-- Tab: Nieuwsbrief -->
                <div id="tab-nieuwsbrief" class="tab-content">
                    <div class="info-section" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 8px;">ğŸ“§ Nieuwsbrief versturen</h3>
                        <p style="font-size: 0.85rem; color: var(--gray-500);">Stuur een nieuwsbrief naar alle ambassadeurs met een emailadres.</p>
                        <p id="nieuwsbrief-count" style="font-size: 0.85rem; color: var(--street-blue); font-weight: 600; margin-top: 8px;">Laden...</p>
                    </div>

                    <div class="info-section" style="margin-bottom: 16px;">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 0.78rem;">Onderwerp *</label>
                            <input type="text" id="nieuwsbrief-onderwerp" placeholder="Onderwerp van de nieuwsbrief" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                        </div>
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label style="font-size: 0.78rem;">Bericht *</label>
                            <textarea id="nieuwsbrief-bericht" rows="10" placeholder="Schrijf hier je nieuwsbrief...&#10;&#10;Gebruik dubbele enters voor nieuwe alinea's." style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%; resize: vertical; line-height: 1.4;"></textarea>
                        </div>
                        <button onclick="verstuurNieuwsbrief()" class="btn btn-gold btn-small" id="nieuwsbrief-send-btn">ğŸ“§ Verstuur nieuwsbrief</button>
                    </div>
                </div>

                <!-- AVG Tab -->
                <div id="tab-avg" class="tab-content">
                    <div style="text-align:center;margin-bottom:20px;">
                        <img src="images/avg-proof-logo.jpg" alt="AVG Proof" style="width:120px;border-radius:12px;">
                    </div>

                    <div class="info-section" style="margin-bottom:16px;">
                        <h3 style="margin-bottom:8px;">ğŸ“‹ Verwerkingsregister</h3>
                        <p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:12px;">Overzicht van alle persoonsgegevens die wij verwerken, conform AVG artikel 30.</p>
                        
                        <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;font-size:0.75rem;min-width:600px;">
                            <thead>
                                <tr style="background:var(--night-blue);color:#fff;">
                                    <th style="padding:8px;text-align:left;">Verwerking</th>
                                    <th style="padding:8px;text-align:left;">Gegevens</th>
                                    <th style="padding:8px;text-align:left;">Doel</th>
                                    <th style="padding:8px;text-align:left;">Grondslag</th>
                                    <th style="padding:8px;text-align:left;">Bewaartermijn</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom:1px solid var(--gray-100);">
                                    <td style="padding:8px;font-weight:600;">Ambassadeurs</td>
                                    <td style="padding:8px;">Naam, straat, huisnr, telefoon, email</td>
                                    <td style="padding:8px;">CoÃ¶rdinatie buurtnetwerk</td>
                                    <td style="padding:8px;">Toestemming</td>
                                    <td style="padding:8px;">Tot 1 jaar na uitschrijving</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--gray-100);background:#f9fafb;">
                                    <td style="padding:8px;font-weight:600;">Potje aanvragen</td>
                                    <td style="padding:8px;">Naam, straat, telefoon, email, IBAN, tenaamstelling</td>
                                    <td style="padding:8px;">Uitkering buurtbudget â‚¬100</td>
                                    <td style="padding:8px;">Overeenkomst</td>
                                    <td style="padding:8px;">IBAN: 30d na uitbetaling. Overig: 3 jaar (fiscaal)</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--gray-100);">
                                    <td style="padding:8px;font-weight:600;">Afrekeningen</td>
                                    <td style="padding:8px;">Naam, straat, bonnetjes, bedragen</td>
                                    <td style="padding:8px;">FinanciÃ«le verantwoording</td>
                                    <td style="padding:8px;">Wettelijke plicht</td>
                                    <td style="padding:8px;">3 jaar (fiscale bewaarplicht)</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--gray-100);background:#f9fafb;">
                                    <td style="padding:8px;font-weight:600;">Aanmeldingen</td>
                                    <td style="padding:8px;">Naam, straat, telefoon, email, motivatie</td>
                                    <td style="padding:8px;">Beoordeling nieuwe ambassadeurs</td>
                                    <td style="padding:8px;">Toestemming</td>
                                    <td style="padding:8px;">Bij afwijzing: direct verwijderd</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--gray-100);">
                                    <td style="padding:8px;font-weight:600;">Contactformulier</td>
                                    <td style="padding:8px;">Naam, email, bericht</td>
                                    <td style="padding:8px;">Beantwoorden vragen</td>
                                    <td style="padding:8px;">Gerechtvaardigd belang</td>
                                    <td style="padding:8px;">6 maanden</td>
                                </tr>
                                <tr style="background:#f9fafb;">
                                    <td style="padding:8px;font-weight:600;">Kerngroep login</td>
                                    <td style="padding:8px;">Naam, email, PIN (gehasht), laatste login</td>
                                    <td style="padding:8px;">Toegangsbeheer beheerpaneel</td>
                                    <td style="padding:8px;">Gerechtvaardigd belang</td>
                                    <td style="padding:8px;">Zolang lid van kerngroep</td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <div class="info-section" style="margin-bottom:16px;">
                        <h3 style="margin-bottom:8px;">ğŸ¢ Verwerkingsverantwoordelijke</h3>
                        <div style="font-size:0.82rem;line-height:1.8;">
                            <p><strong>Organisatie:</strong> Straatambassadeurs Vathorst & Hooglanderveen</p>
                            <p><strong>Contactpersoon:</strong> Stefan Dijkstra (kerngroep)</p>
                            <p><strong>E-mail:</strong> info@straatambassadeurs.nl</p>
                            <p><strong>Adres:</strong> Beemster 26, 3825 KC Amersfoort</p>
                        </div>
                    </div>

                    <div class="info-section" style="margin-bottom:16px;">
                        <h3 style="margin-bottom:8px;">ğŸ”§ Verwerkers & Sub-verwerkers</h3>
                        <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;font-size:0.75rem;min-width:500px;">
                            <thead>
                                <tr style="background:var(--night-blue);color:#fff;">
                                    <th style="padding:8px;text-align:left;">Dienst</th>
                                    <th style="padding:8px;text-align:left;">Verwerker</th>
                                    <th style="padding:8px;text-align:left;">Locatie</th>
                                    <th style="padding:8px;text-align:left;">Overeenkomst</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom:1px solid var(--gray-100);">
                                    <td style="padding:8px;">Database</td>
                                    <td style="padding:8px;">Supabase Inc.</td>
                                    <td style="padding:8px;">VS + Singapore</td>
                                    <td style="padding:8px;">âœ… DPA + TIA</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--gray-100);background:#f9fafb;">
                                    <td style="padding:8px;">Hosting</td>
                                    <td style="padding:8px;">Netlify Inc.</td>
                                    <td style="padding:8px;">VS</td>
                                    <td style="padding:8px;">âœ… DPA</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--gray-100);">
                                    <td style="padding:8px;">E-mail (transactie)</td>
                                    <td style="padding:8px;">Resend / Amazon SES</td>
                                    <td style="padding:8px;">VS</td>
                                    <td style="padding:8px;">âœ… DPA</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--gray-100);background:#f9fafb;">
                                    <td style="padding:8px;">E-mail (forward)</td>
                                    <td style="padding:8px;">ImprovMX</td>
                                    <td style="padding:8px;">EU (Frankrijk)</td>
                                    <td style="padding:8px;">âœ… EU</td>
                                </tr>
                                <tr style="border-bottom:1px solid var(--gray-100);">
                                    <td style="padding:8px;">Captcha</td>
                                    <td style="padding:8px;">Cloudflare Turnstile</td>
                                    <td style="padding:8px;">VS + EU</td>
                                    <td style="padding:8px;">âœ… DPA</td>
                                </tr>
                                <tr>
                                    <td style="padding:8px;">Domein</td>
                                    <td style="padding:8px;">TransIP B.V.</td>
                                    <td style="padding:8px;">NL</td>
                                    <td style="padding:8px;">âœ… NL</td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <div class="info-section" style="margin-bottom:16px;">
                        <h3 style="margin-bottom:8px;">ğŸ›¡ï¸ Beveiligingsmaatregelen</h3>
                        <ul style="font-size:0.82rem;line-height:1.8;padding-left:20px;">
                            <li><strong>Versleuteling:</strong> HTTPS/TLS op alle pagina's</li>
                            <li><strong>Toegangsbeheer:</strong> Persoonlijke PIN per kerngroeplid (SHA-256 gehasht)</li>
                            <li><strong>IBAN bescherming:</strong> Automatisch verwijderd 30 dagen na uitbetaling</li>
                            <li><strong>Spam-bescherming:</strong> Cloudflare Turnstile + honeypot velden</li>
                            <li><strong>PIN verificatie:</strong> Server-side (hashes nooit naar browser)</li>
                            <li><strong>Database:</strong> Row Level Security (RLS) actief</li>
                            <li><strong>Back-ups:</strong> Dagelijks via Supabase (automatisch)</li>
                        </ul>
                    </div>

                    <div class="info-section" style="margin-bottom:16px;">
                        <h3 style="margin-bottom:8px;">ğŸ“„ Documenten</h3>
                        <div style="display:flex;flex-wrap:wrap;gap:8px;">
                            <a href="privacy.html" target="_blank" class="ql-btn" style="background:var(--street-blue);">ğŸ“„ Privacyverklaring</a>
                            <a href="docs/supabase-dpa.pdf" target="_blank" class="ql-btn" style="background:#059669;">ğŸ“‹ Supabase DPA</a>
                            <a href="docs/supabase-tia.pdf" target="_blank" class="ql-btn" style="background:#6366f1;">ğŸ“‹ Supabase TIA</a>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3 style="margin-bottom:8px;">ğŸ“… Logboek</h3>
                        <table style="width:100%;border-collapse:collapse;font-size:0.75rem;">
                            <tbody>
                                <tr style="border-bottom:1px solid var(--gray-100);">
                                    <td style="padding:6px;color:var(--gray-400);white-space:nowrap;">12 feb 2026</td>
                                    <td style="padding:6px;">Verwerkingsregister aangemaakt, DPA+TIA getekend, privacyverklaring live, PIN-systeem live, foto's vervangen</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Contact -->
                <div id="tab-contact" class="tab-content">
                    <div class="info-section" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 8px;">ğŸ“¬ Contactberichten</h3>
                        <p style="font-size: 0.85rem; color: var(--gray-500);">Berichten via het contactformulier. Klik op "Reageer" om direct te antwoorden.</p>
                    </div>
                    <div id="contact-list">
                        <p style="text-align: center; color: var(--gray-400); padding: 12px;">Laden...</p>
                    </div>
                </div>

                <!-- Modal: Contact reageren -->
                <div id="contact-reply-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
                    <div style="background:#fff;border-radius:12px;max-width:500px;width:90%;padding:24px;margin:auto;position:relative;top:50%;transform:translateY(-50%);">
                        <h3 style="margin:0 0 4px;">ğŸ’¬ Reageer op bericht</h3>
                        <p id="contact-reply-info" style="font-size:0.82rem;color:var(--gray-500);margin-bottom:12px;"></p>
                        <div style="background:var(--gray-100);border-radius:8px;padding:12px;margin-bottom:12px;font-size:0.82rem;">
                            <strong>Origineel bericht:</strong>
                            <p id="contact-reply-original" style="margin:6px 0 0;white-space:pre-wrap;color:var(--gray-600);"></p>
                        </div>
                        <div class="form-group" style="margin-bottom:12px;">
                            <label style="font-size:0.78rem;">Je antwoord *</label>
                            <textarea id="contact-reply-text" rows="5" placeholder="Typ hier je antwoord..." style="padding:8px;border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.82rem;width:100%;resize:vertical;"></textarea>
                        </div>
                        <div style="display:flex;gap:8px;">
                            <button onclick="sendContactReply()" class="btn btn-gold btn-small" id="contact-reply-send-btn">ğŸ“§ Verstuur antwoord</button>
                            <button onclick="closeContactReplyModal()" class="btn btn-secondary btn-small">Annuleren</button>
                        </div>
                    </div>
                </div>

            </main>

            <footer>
                <div class="footer-houses"></div>
                <div class="footer-title">Straatambassadeurs Beheer</div>
            </footer>
        </div>
    </div>

    <!-- Dynamic Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="supabase-config.js"></script>
    <script>
        // Kerngroep PIN data wordt geladen uit Supabase kerngroep_pins tabel
        let kerngroepPinsData = [];

        let aanvragenData = [];
        let ambassadeursData = [];
        let aanmeldingenData = [];
        let potjeUitgavenData = [];
        let potjeToekenningenData = [];
        let notulenData = [];
        let potjesTablesExist = true;
        
        // =====================
        // DOUBLE-CLICK PREVENTION
        // =====================
        function disableBtn(btn, loadingText) {
            if (!btn) return;
            btn.disabled = true;
            btn._origText = btn.textContent;
            if (loadingText) btn.textContent = loadingText;
            btn.classList.add('btn-loading');
        }
        function enableBtn(btn) {
            if (!btn) return;
            btn.disabled = false;
            if (btn._origText) btn.textContent = btn._origText;
            btn.classList.remove('btn-loading');
        }

        // Helper: get current admin name
        function getAdminNaam() {
            return localStorage.getItem('admin_naam') || '';
        }

        // SHA-256 hash helper
        async function sha256(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Laad kerngroepleden uit Supabase voor de dropdown (alleen namen, geen hashes)
        async function loadKerngroepPins() {
            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('kerngroep_pins')
                        .select('naam')
                        .order('naam');
                    if (error) throw error;
                    kerngroepPinsData = data || [];
                }
            } catch (e) {
                console.error('Kon kerngroep_pins niet laden, gebruik fallback:', e);
                kerngroepPinsData = [];
            }
            
            // Fallback: als tabel nog niet bestaat, hardcoded namen tonen
            if (kerngroepPinsData.length === 0) {
                kerngroepPinsData = [
                    { naam: 'Stefan Dijkstra' },
                    { naam: 'Bejanca Eilander' },
                    { naam: 'Carien Veldhuis' },
                    { naam: 'Gerry Rispens' },
                    { naam: 'Kundike Sinselmeijer' },
                    { naam: 'Richard Kamer' }
                ];
            }
            
            const select = document.getElementById('login-naam');
            select.innerHTML = '<option value="">Selecteer je naam...</option>';
            kerngroepPinsData.forEach(k => {
                const voornaam = k.naam.split(' ')[0];
                const opt = document.createElement('option');
                opt.value = k.naam;
                opt.textContent = voornaam;
                select.appendChild(opt);
            });
        }

        // Login functie
        async function doLogin() {
            const naam = document.getElementById('login-naam').value;
            const pin = document.getElementById('pin').value;
            const errorEl = document.getElementById('login-error');
            const submitBtn = document.querySelector('#login-form button');
            
            if (!naam || !pin) {
                errorEl.textContent = !naam ? 'Selecteer je naam' : 'Voer je PIN in';
                errorEl.classList.remove('hidden');
                return;
            }
            
            if (pin.length !== 5) {
                errorEl.textContent = 'PIN moet 5 cijfers zijn';
                errorEl.classList.remove('hidden');
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Controleren...';
            errorEl.classList.add('hidden');
            
            try {
                // Server-side PIN verificatie (hashes blijven op de server)
                const resp = await fetch('/.netlify/functions/verify-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ naam, pin })
                });
                const result = await resp.json();
                
                if (result.success) {
                    localStorage.setItem('admin_naam', naam);
                    localStorage.setItem('admin_login_tijd', new Date().toISOString());
                    sessionStorage.setItem('admin_logged_in', 'true');
                    showDashboard();
                } else {
                    errorEl.textContent = result.error || 'Onjuiste pincode';
                    errorEl.classList.remove('hidden');
                    document.getElementById('pin').value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'Er ging iets mis. Probeer opnieuw.';
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Inloggen';
            }
        }
        
        // PIN vergeten modal
        function showPinVergetenModal() {
            const options = kerngroepPinsData.map(k => {
                const voornaam = k.naam.split(' ')[0];
                return `<option value="${k.naam}">${voornaam}</option>`;
            }).join('');
            
            openModal('ğŸ”‘ PIN vergeten', `
                <p style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 16px;">Selecteer je naam en we sturen een nieuwe PIN naar je e-mailadres.</p>
                <div class="form-group">
                    <label style="font-size: 0.82rem; font-weight: 600;">Naam</label>
                    <select id="reset-pin-naam" style="width: 100%; padding: 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.9rem; background: #fff;">
                        <option value="">Selecteer je naam...</option>
                        ${options}
                    </select>
                </div>
                <div id="reset-pin-result" style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 0.85rem;"></div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-primary" id="btn-reset-pin" onclick="requestPinReset()">ğŸ“§ Nieuwe PIN aanvragen</button>
            `, { maxWidth: '400px' });
        }
        
        async function requestPinReset() {
            const naam = document.getElementById('reset-pin-naam').value;
            const resultEl = document.getElementById('reset-pin-result');
            const btn = document.getElementById('btn-reset-pin');
            
            if (!naam) {
                resultEl.style.display = 'block';
                resultEl.style.background = '#fee2e2';
                resultEl.style.color = '#991b1b';
                resultEl.textContent = 'Selecteer eerst je naam';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Versturen...';
            
            try {
                const res = await fetch('/.netlify/functions/reset-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ naam })
                });
                const data = await res.json();
                
                if (data.success) {
                    resultEl.style.display = 'block';
                    resultEl.style.background = '#d1fae5';
                    resultEl.style.color = '#065f46';
                    resultEl.textContent = 'âœ… Een nieuwe PIN is verstuurd naar je e-mailadres.';
                    btn.style.display = 'none';
                    
                    // Herlaad pin data zodat de nieuwe hash beschikbaar is
                    setTimeout(() => loadKerngroepPins(), 2000);
                } else {
                    resultEl.style.display = 'block';
                    resultEl.style.background = '#fee2e2';
                    resultEl.style.color = '#991b1b';
                    resultEl.textContent = data.error || 'Er ging iets mis';
                }
            } catch (error) {
                resultEl.style.display = 'block';
                resultEl.style.background = '#fee2e2';
                resultEl.style.color = '#991b1b';
                resultEl.textContent = 'Kon geen verbinding maken met de server';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“§ Nieuwe PIN aanvragen';
            }
        }
        
        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            // Show logged-in user in header
            const naam = getAdminNaam();
            const label = document.getElementById('admin-user-label');
            if (label && naam) {
                label.textContent = 'Ingelogd als: ' + naam.split(' ')[0];
            }
            loadAllData();
        }
        
        function logout() {
            localStorage.removeItem('admin_naam');
            localStorage.removeItem('admin_login_tijd');
            sessionStorage.removeItem('admin_logged_in');
            location.reload();
        }
        
        // Check session
        document.addEventListener('DOMContentLoaded', () => {
            // supabase-config.js already creates window.supabaseClient via CDN
            // If not ready yet, try manually
            if (!window.supabaseClient && window.supabase && window.supabase.createClient) {
                window.supabaseClient = window.supabase.createClient('https://knxdefuncbzzbrunhlxg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtueGRlZnVuY2J6emJydW5obHhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMjM0NzIsImV4cCI6MjA4NTU5OTQ3Mn0.QRQ0uxK65s_9EaVZkqpFMGOGCvpH5GKisHqg1ZZay3Y');
            }
            if (window.supabaseClient) {
                console.log('âœ… Supabase admin client ready');
            } else {
                console.error('âŒ Supabase client not available');
            }
            // Laad kerngroepleden voor login dropdown
            loadKerngroepPins();
            
            if (sessionStorage.getItem('admin_logged_in') === 'true' && localStorage.getItem('admin_naam')) {
                showDashboard();
            }
        });
        
        // Tabs
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const tabEl = document.getElementById(`tab-${tab}`);
            if (tabEl) tabEl.classList.add('active');
            // Find matching button
            document.querySelectorAll('.tab-btn').forEach(b => {
                if (b.getAttribute('onclick')?.includes(`'${tab}'`)) b.classList.add('active');
            });
            if (tab === 'nieuwsbrief' && typeof updateNieuwsbriefCount === 'function') updateNieuwsbriefCount();
        }
        
        // Deep link: open tab via ?tab=xxx
        (function() {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if (tab) setTimeout(() => showTab(tab), 500);
        })();
        
        // Load all data
        async function loadAllData() {
            // AVG: IBAN cleanup voor uitbetaalde aanvragen >30 dagen
            await cleanupExpiredIBANs();
            await Promise.all([
                loadAanvragen(),
                loadAmbassadeurs(),
                loadAanmeldingen(),
                loadAfrekeningen(),
                loadPotjes(),
                loadFinancien(),
                loadNotulen(),
                loadNieuws(),
                loadContactberichten()
            ]);
            updateStats();
            initPotjesJaarFilter();
            initFinancienJaarFilter();
            populateAmbassadeurDropdown();
        }
        
        // Load Aanvragen
        async function loadAanvragen() {
            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('aanvragen')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    aanvragenData = data || [];
                }
                renderAanvragen();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderAanvragen() {
            const tbody = document.getElementById('aanvragen-tbody');
            const filterStatus = document.getElementById('filter-status').value;
            const filterSearch = document.getElementById('filter-search').value.toLowerCase();
            
            let filtered = aanvragenData;
            if (filterStatus) {
                filtered = filtered.filter(a => a.status === filterStatus);
            }
            if (filterSearch) {
                filtered = filtered.filter(a => 
                    a.ambassadeur_naam?.toLowerCase().includes(filterSearch) ||
                    a.straat?.toLowerCase().includes(filterSearch) ||
                    a.doel?.toLowerCase().includes(filterSearch)
                );
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Geen aanvragen gevonden</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(a => `
                <tr>
                    <td data-label="Datum">${formatDate(a.created_at)}</td>
                    <td data-label="Ambassadeur"><strong>${a.ambassadeur_naam || '-'}</strong></td>
                    <td data-label="Straat">${a.straat || '-'}</td>
                    <td data-label="Doel" style="max-width: 200px;">${truncate(a.doel, 50)}</td>
                    <td data-label="Status"><span class="status-badge ${a.status}">${formatStatus(a.status)}</span></td>
                    <td data-label="Acties">
                        <div class="action-group">
                            <button class="btn-icon" onclick="showDetail('${a.id}')" title="Details bekijken">ğŸ‘ï¸</button>
                            ${a.status === 'nieuw' || a.status === 'in_behandeling' || a.status === 'info_gevraagd' ? `
                                ${a.status === 'nieuw' ? `<button class="btn-icon btn-warning" onclick="handleInBehandeling('${a.id}')" title="In behandeling nemen">â³</button>` : ''}
                                <button class="btn-icon" onclick="handleMeerInfoAanvraag('${a.id}')" title="Meer informatie vragen" style="background: #e0f2fe; color: #0369a1;">â„¹ï¸</button>
                                <button class="btn-icon btn-success" onclick="handleToewijzen('${a.id}')" title="Toewijzen">âœ…</button>
                                <button class="btn-icon btn-danger" onclick="handleAfwijzen('${a.id}')" title="Afwijzen">âŒ</button>
                            ` : `<button class="btn-icon" onclick="handleHeropenen('${a.id}')" title="Heropenen" style="background:#fef3c7;color:#92400e;">ğŸ”„</button>`}
                            <label title="Uitbetaald" style="display:inline-flex;align-items:center;gap:2px;cursor:pointer;font-size:0.7rem;" onclick="event.stopPropagation()">
                                <input type="checkbox" ${a.uitbetaald ? 'checked' : ''} onchange="updateTracking('${a.id}','uitbetaald',this.checked)" style="width:16px;height:16px;accent-color:#10b981;">ğŸ’³
                            </label>
                            <label title="OneDrive archief" style="display:inline-flex;align-items:center;gap:2px;cursor:pointer;font-size:0.7rem;" onclick="event.stopPropagation()">
                                <input type="checkbox" ${a.onedrive_archief ? 'checked' : ''} onchange="updateTracking('${a.id}','onedrive_archief',this.checked)" style="width:16px;height:16px;accent-color:#3b82f6;">ğŸ“
                            </label>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterAanvragen() {
            renderAanvragen();
        }
        
        // Load Ambassadeurs
        async function loadAmbassadeurs() {
            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .select('*')
                        .order('naam');
                    
                    if (error) throw error;
                    ambassadeursData = data || [];
                }
                renderAmbassadeurs();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderAmbassadeurs() {
            const tbody = document.getElementById('ambassadeurs-tbody');
            
            if (ambassadeursData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 24px; color: var(--gray-400);">Geen ambassadeurs</td></tr>';
                return;
            }
            
            tbody.innerHTML = ambassadeursData.map(a => {
                // Calculate potje info for this ambassadeur
                const toekenning = potjeToekenningenData.find(t => t.ambassadeur_id === a.id);
                const uitgaven = potjeUitgavenData.filter(u => u.ambassadeur_id === a.id);
                const budget = toekenning ? parseFloat(toekenning.bedrag) : 0;
                const besteed = uitgaven.reduce((sum, u) => sum + (parseFloat(u.bedrag) || 0), 0);
                const potjeHtml = budget > 0 
                    ? `<span style="font-size: 0.7rem; padding: 1px 5px; border-radius: 6px; background: ${besteed >= budget ? '#fee2e2' : '#d1fae5'}; color: ${besteed >= budget ? '#991b1b' : '#065f46'}; font-weight: 600;">â‚¬${besteed.toFixed(0)}/â‚¬${budget.toFixed(0)}</span>`
                    : '';
                return `
                <tr style="${!a.actief ? 'opacity: 0.5;' : ''} cursor: pointer;" onclick="editAmbassadeur('${a.id}')">
                    <td data-label="Naam"><strong>${a.naam}</strong> ${potjeHtml}</td>
                    <td data-label="Straat">${a.straat || '-'}</td>
                    <td data-label="Huisnr">${a.huisnummer || '-'}</td>
                    <td data-label="Telefoon">${a.telefoon || '-'}</td>
                    <td data-label="Email" style="font-size: 0.78rem;">${a.email || '-'}</td>
                    <td data-label="Kerngroep">${a.kerngroep_bezoek ? 'âœ…' : 'âŒ'}</td>
                    <td data-label="Actief">${a.actief ? 'âœ…' : 'âŒ'}</td>
                    <td data-label="Acties" onclick="event.stopPropagation();">
                        <div class="action-group">
                            <button class="btn-icon" onclick="editAmbassadeur('${a.id}')" title="Bewerken">âœï¸</button>
                            <button class="btn-icon" onclick="toggleAmbassadeur('${a.id}', ${!a.actief})" title="${a.actief ? 'Deactiveren' : 'Activeren'}">
                                ${a.actief ? 'ğŸš«' : 'âœ…'}
                            </button>
                            <button class="btn-icon btn-danger" onclick="deleteAmbassadeur('${a.id}')" title="Verwijderen">ğŸ—‘ï¸</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }
        
        async function addAmbassadeur() {
            const naam = document.getElementById('new-amb-naam').value.trim();
            const straat = document.getElementById('new-amb-straat').value.trim();
            const huisnummer = document.getElementById('new-amb-huisnummer').value.trim();
            const telefoon = document.getElementById('new-amb-telefoon').value.trim();
            const email = document.getElementById('new-amb-email').value.trim();
            const opmerkingen = document.getElementById('new-amb-opmerkingen').value.trim();
            const kerngroepBezoek = document.getElementById('new-amb-kerngroep-bezoek').checked;
            
            if (!naam || !straat) {
                alert('Vul minimaal naam en straat in');
                return;
            }
            
            const btn = event?.target;
            disableBtn(btn, 'Toevoegen...');
            
            try {
                if (window.supabaseClient) {
                    const insertData = { naam, straat, actief: true, kerngroep_bezoek: kerngroepBezoek };
                    if (huisnummer) insertData.huisnummer = huisnummer;
                    if (telefoon) insertData.telefoon = telefoon;
                    if (email) insertData.email = email;
                    if (opmerkingen) insertData.opmerkingen = opmerkingen;
                    
                    const { error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .insert([insertData]);
                    
                    if (error) throw error;
                }
                
                document.getElementById('new-amb-naam').value = '';
                document.getElementById('new-amb-straat').value = '';
                document.getElementById('new-amb-huisnummer').value = '';
                document.getElementById('new-amb-telefoon').value = '';
                document.getElementById('new-amb-email').value = '';
                document.getElementById('new-amb-opmerkingen').value = '';
                document.getElementById('new-amb-kerngroep-bezoek').checked = false;
                showToast('Ambassadeur toegevoegd! ğŸ‰', 'success');
                await loadAmbassadeurs();
                updateStats();
                populateAmbassadeurDropdown();
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis bij het toevoegen: ' + (error.message || 'onbekende fout'), 'error');
            } finally {
                enableBtn(btn);
            }
        }
        
        // Edit ambassadeur modal
        function editAmbassadeur(id) {
            const amb = ambassadeursData.find(a => a.id === id);
            if (!amb) return;
            
            openModal('âœï¸ Ambassadeur bewerken', `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.85rem;">Naam *</label>
                        <input type="text" id="edit-amb-naam" value="${amb.naam || ''}" style="width: 100%; padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.88rem;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.85rem;">Straat *</label>
                        <input type="text" id="edit-amb-straat" value="${amb.straat || ''}" style="width: 100%; padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.88rem;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.85rem;">Huisnummer</label>
                        <input type="text" id="edit-amb-huisnummer" value="${amb.huisnummer || ''}" style="width: 100%; padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.88rem;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.85rem;">Telefoon</label>
                        <input type="text" id="edit-amb-telefoon" value="${amb.telefoon || ''}" style="width: 100%; padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.88rem;">
                    </div>
                    <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                        <label style="font-size: 0.85rem;">Email</label>
                        <input type="email" id="edit-amb-email" value="${amb.email || ''}" style="width: 100%; padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.88rem;">
                    </div>
                    <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                        <label style="font-size: 0.85rem;">Opmerkingen / Notities</label>
                        <textarea id="edit-amb-opmerkingen" rows="3" style="width: 100%; padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.88rem; resize: vertical;">${amb.opmerkingen || ''}</textarea>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
                            <input type="checkbox" id="edit-amb-actief" ${amb.actief ? 'checked' : ''}>
                            Actief
                        </label>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
                            <input type="checkbox" id="edit-amb-kerngroep-bezoek" ${amb.kerngroep_bezoek ? 'checked' : ''}>
                            Kerngroep bezoek?
                        </label>
                    </div>
                </div>
                <div style="margin-top: 12px; font-size: 0.75rem; color: var(--gray-400);">
                    ID: ${amb.id} Â· Aangemeld: ${formatDateTime(amb.created_at)}
                </div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals(); deleteAmbassadeur('${amb.id}');" style="background: #fee2e2; color: #991b1b; border-color: #fecaca;">ğŸ—‘ï¸ Verwijderen</button>
                <div style="flex: 1;"></div>
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-primary" id="btn-save-ambassadeur" onclick="saveAmbassadeur('${amb.id}')">ğŸ’¾ Opslaan</button>
            `, { maxWidth: '520px' });
        }
        
        async function saveAmbassadeur(id) {
            const naam = document.getElementById('edit-amb-naam').value.trim();
            const straat = document.getElementById('edit-amb-straat').value.trim();
            const huisnummer = document.getElementById('edit-amb-huisnummer').value.trim();
            const telefoon = document.getElementById('edit-amb-telefoon').value.trim();
            const email = document.getElementById('edit-amb-email').value.trim();
            const opmerkingen = document.getElementById('edit-amb-opmerkingen').value.trim();
            const actief = document.getElementById('edit-amb-actief').checked;
            const kerngroepBezoek = document.getElementById('edit-amb-kerngroep-bezoek').checked;
            
            if (!naam || !straat) {
                showToast('Naam en straat zijn verplicht', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-save-ambassadeur');
            if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; btn.textContent = 'Opslaan...'; }
            
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .update({
                            naam, straat, actief,
                            huisnummer: huisnummer || null,
                            telefoon: telefoon || null,
                            email: email || null,
                            opmerkingen: opmerkingen || null,
                            kerngroep_bezoek: kerngroepBezoek
                        })
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                
                closeAllModals();
                showToast('Ambassadeur bijgewerkt âœ…', 'success');
                await loadAmbassadeurs();
                updateStats();
                populateAmbassadeurDropdown();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis bij het opslaan', 'error');
                if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; btn.textContent = 'ğŸ’¾ Opslaan'; }
            }
        }
        
        async function toggleAmbassadeur(id, actief) {
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .update({ actief })
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                showToast(actief ? 'Ambassadeur geactiveerd âœ…' : 'Ambassadeur gedeactiveerd', 'success');
                await loadAmbassadeurs();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis: ' + (error.message || 'onbekende fout'), 'error');
            }
        }
        
        async function deleteAmbassadeur(id) {
            if (!confirm('Weet je het zeker? Deze ambassadeur wordt permanent verwijderd.')) return;
            
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                showToast('Ambassadeur verwijderd', 'info');
                await loadAmbassadeurs();
                updateStats();
                populateAmbassadeurDropdown();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis bij het verwijderen: ' + (error.message || 'onbekende fout'), 'error');
            }
        }
        
        // Load Aanmeldingen (nieuwe ambassadeurs)
        async function loadAanmeldingen() {
            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('aanmeldingen')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    aanmeldingenData = data || [];
                }
                renderAanmeldingen();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderAanmeldingen() {
            const tbody = document.getElementById('aanmeldingen-tbody');
            
            if (aanmeldingenData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Geen aanmeldingen</td></tr>';
                return;
            }
            
            tbody.innerHTML = aanmeldingenData.map(a => `
                <tr>
                    <td data-label="Datum">${formatDate(a.created_at)}</td>
                    <td data-label="Naam"><strong>${a.naam}</strong></td>
                    <td data-label="Straat">${a.straat}</td>
                    <td data-label="Telefoon">${a.telefoon || '-'}</td>
                    <td data-label="Status"><span class="status-badge ${a.status}">${formatStatus(a.status)}</span></td>
                    <td data-label="Acties">
                        <div class="action-group">
                            ${a.status === 'nieuw' || a.status === 'info_gevraagd' ? `
                                <button class="btn-icon" onclick="handleMeerInfoAanmelding('${a.id}')" title="Meer informatie vragen" style="background: #e0f2fe; color: #0369a1;">â„¹ï¸</button>
                                <button class="btn-icon btn-success" onclick="handleApproveAanmelding('${a.id}')" title="Goedkeuren & toevoegen">âœ…</button>
                                <button class="btn-icon btn-danger" onclick="handleRejectAanmelding('${a.id}')" title="Afwijzen">âŒ</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // =====================
        // TOAST NOTIFICATIONS
        // =====================
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'â„¹ï¸'}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('toast-hide');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // =====================
        // MODAL SYSTEM
        // =====================
        function openModal(title, bodyHtml, footerHtml = '', options = {}) {
            const container = document.getElementById('modal-container');
            const id = 'modal-' + Date.now();
            container.innerHTML = `
                <div id="${id}" class="modal-overlay" onclick="if(event.target===this)closeModal('${id}')">
                    <div class="modal-box" style="${options.maxWidth ? 'max-width:' + options.maxWidth : ''}">
                        <div class="modal-box-header">
                            <h3>${title}</h3>
                            <button class="modal-box-close" onclick="closeModal('${id}')">Ã—</button>
                        </div>
                        <div class="modal-box-body">${bodyHtml}</div>
                        ${footerHtml ? `<div class="modal-box-footer">${footerHtml}</div>` : ''}
                    </div>
                </div>
            `;
            return id;
        }
        
        function closeModal(id) {
            const modal = id ? document.getElementById(id) : document.querySelector('.modal-overlay');
            if (modal) {
                modal.classList.add('modal-hide');
                setTimeout(() => modal.remove(), 200);
            }
        }

        function openHandmatigeAanvraagModal() {
            const body = `
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <div><label style="font-weight:600;font-size:0.85rem;">Ambassadeur naam *</label><input type="text" id="ha-naam" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:4px;"></div>
                    <div><label style="font-weight:600;font-size:0.85rem;">Straat *</label><input type="text" id="ha-straat" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:4px;"></div>
                    <div><label style="font-weight:600;font-size:0.85rem;">Telefoon</label><input type="text" id="ha-telefoon" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:4px;"></div>
                    <div><label style="font-weight:600;font-size:0.85rem;">Email</label><input type="email" id="ha-email" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:4px;"></div>
                    <div><label style="font-weight:600;font-size:0.85rem;">Doel *</label><input type="text" id="ha-doel" placeholder="bijv. Geboorte, Overlijden..." style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:4px;"></div>
                    <div><label style="font-weight:600;font-size:0.85rem;">Bedrag (â‚¬)</label><input type="number" id="ha-bedrag" value="100" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin-top:4px;"></div>
                </div>`;
            const footer = `<button onclick="submitHandmatigeAanvraag()" style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;border-radius:6px;font-size:0.82rem;font-weight:600;background:#16a34a;color:#fff;border:none;cursor:pointer;">âœ… Toevoegen</button>`;
            openModal('â• Handmatige aanvraag toevoegen', body, footer, { maxWidth: '500px' });
        }

        async function submitHandmatigeAanvraag() {
            const naam = document.getElementById('ha-naam')?.value?.trim();
            const straat = document.getElementById('ha-straat')?.value?.trim();
            const telefoon = document.getElementById('ha-telefoon')?.value?.trim();
            const email = document.getElementById('ha-email')?.value?.trim();
            const doel = document.getElementById('ha-doel')?.value?.trim();
            const bedrag = parseFloat(document.getElementById('ha-bedrag')?.value) || 100;

            if (!naam || !straat || !doel) {
                showToast('Vul minimaal naam, straat en doel in', 'error');
                return;
            }

            const { error } = await window.supabaseClient.from('aanvragen').insert([{
                ambassadeur_naam: naam,
                straat: straat,
                telefoon: telefoon || null,
                email: email || null,
                doel: doel,
                bedrag: bedrag,
                status: 'nieuw'
            }]);

            if (error) {
                showToast('Fout bij toevoegen: ' + error.message, 'error');
                return;
            }

            closeModal();
            showToast('âœ… Aanvraag toegevoegd!', 'success');
            await loadAanvragen();
            renderAanvragen();
        }
        
        function closeAllModals() {
            document.getElementById('modal-container').innerHTML = '';
        }
        
        // =====================
        // AANVRAGEN ACTIONS
        // =====================
        
        // In behandeling nemen
        // ===== BACKUP =====
        async function exportBackup() {
            showToast('ğŸ’¾ Backup wordt gemaakt...', 'info');
            try {
                const tables = ['ambassadeurs', 'aanvragen', 'aanmeldingen', 'potje_afrekeningen', 'potje_toekenningen', 'potje_uitgaven', 'notulen', 'contactberichten', 'nieuws'];
                const backup = { exportDate: new Date().toISOString(), tables: {} };
                for (const table of tables) {
                    const { data, error } = await window.supabaseClient.from(table).select('*');
                    backup.tables[table] = { count: (data || []).length, data: data || [] };
                }
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sa-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast(`ğŸ’¾ Backup gedownload! ${tables.length} tabellen`, 'success');
            } catch(e) { console.error(e); showToast('Fout bij backup', 'error'); }
        }

        async function handleHeropenen(id) {
            if (!confirm('Aanvraag heropenen en terugzetten naar "nieuw"?')) return;
            try {
                const { error } = await window.supabaseClient
                    .from('aanvragen')
                    .update({ status: 'nieuw', updated_at: new Date().toISOString(), laatst_bewerkt_door: getAdminNaam() })
                    .eq('id', id);
                if (error) throw error;
                showToast('Aanvraag heropend âœ…', 'success');
                await loadAanvragen();
                renderAanvragen();
            } catch(e) { showToast('Fout bij heropenen', 'error'); }
        }

        async function handleInBehandeling(id) {
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            const modalId = openModal('â³ In behandeling nemen', `
                <p class="confirm-message">Wil je de aanvraag van <strong>${aanvraag.ambassadeur_naam}</strong> (${aanvraag.straat}) in behandeling nemen?</p>
                <div class="detail-section">
                    <h4>Doel</h4>
                    <p>${aanvraag.doel || '-'}</p>
                </div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-gold" id="btn-confirm-behandeling" onclick="confirmInBehandeling('${id}')">â³ In behandeling</button>
            `);
        }
        
        async function confirmInBehandeling(id) {
            const btn = document.getElementById('btn-confirm-behandeling');
            if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; }
            
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('aanvragen')
                        .update({ status: 'in_behandeling', updated_at: new Date().toISOString(), laatst_bewerkt_door: getAdminNaam() })
                        .eq('id', id);
                    if (error) throw error;
                }
                closeAllModals();
                showToast('Aanvraag is in behandeling genomen', 'success');
                await loadAanvragen();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis bij het updaten', 'error');
                if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; }
            }
        }
        
        // Toewijzen
        function handleToewijzen(id) {
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            openModal('âœ… Potje toewijzen', `
                <p class="confirm-message">Weet je zeker dat je <strong>â‚¬${aanvraag.bedrag || 100}</strong> wilt toewijzen aan <strong>${aanvraag.ambassadeur_naam}</strong> voor <strong>${aanvraag.straat}</strong>?</p>
                <div class="detail-section">
                    <h4>Aanvraag details</h4>
                    <p><strong>Doel:</strong> ${aanvraag.doel || '-'}</p>
                    <p style="margin-top: 6px;"><strong>IBAN:</strong> ${aanvraag.iban || '-'}</p>
                    <p style="margin-top: 4px;"><strong>t.n.v.:</strong> ${aanvraag.tenaamstelling || '-'}</p>
                </div>
                <div class="confirm-warning">
                    <span>âš ï¸</span>
                    <span>Na toewijzing ontvangt ${aanvraag.ambassadeur_naam} een bevestigingsmail${aanvraag.email ? ` op ${aanvraag.email}` : ''} en de kerngroep wordt genotificeerd.</span>
                </div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-primary" id="btn-confirm-toewijzen" onclick="confirmToewijzen('${id}')">âœ… Toewijzen</button>
            `);
        }
        
        async function confirmToewijzen(id) {
            const btn = document.getElementById('btn-confirm-toewijzen');
            if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; btn.textContent = 'Bezig...'; }
            
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            try {
                // 1. Update status in Supabase
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('aanvragen')
                        .update({ status: 'uitgekeerd', updated_at: new Date().toISOString(), laatst_bewerkt_door: getAdminNaam() })
                        .eq('id', id);
                    if (error) throw error;
                }
                
                // 2. Send notification email
                try {
                    await fetch('/.netlify/functions/notify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'toewijzing',
                            data: {
                                ambassadeur_naam: aanvraag.ambassadeur_naam,
                                straat: aanvraag.straat,
                                doel: aanvraag.doel,
                                email: aanvraag.email,
                                iban: aanvraag.iban,
                                tenaamstelling: aanvraag.tenaamstelling,
                                administratie: aanvraag.administratie,
                                bedrag: aanvraag.bedrag || 100
                            }
                        })
                    });
                } catch (emailErr) {
                    console.error('Email error (non-blocking):', emailErr);
                }
                
                closeAllModals();
                showToast(`â‚¬${aanvraag.bedrag || 100} toegewezen aan ${aanvraag.ambassadeur_naam} ğŸ‰`, 'success', 5000);
                await loadAanvragen();
                updateStats();
                
                // Toon betaalinfo modal
                const iban = aanvraag.iban ? aanvraag.iban.replace(/(.{4})/g, '$1 ').trim() : '-';
                openModal('ğŸ’³ Betaling uitvoeren', `
                    <div style="background:#f0fdf4; border:2px solid #86efac; border-radius:12px; padding:20px; text-align:center; margin-bottom:16px;">
                        <div style="font-size:2rem; margin-bottom:8px;">â‚¬${aanvraag.bedrag || 100}</div>
                        <div style="font-size:0.85rem; color:#374151;">over te maken aan <strong>${aanvraag.ambassadeur_naam}</strong></div>
                        <div style="font-size:0.82rem; color:#6b7280; margin-top:2px;">${aanvraag.straat}</div>
                    </div>
                    <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:16px; margin-bottom:12px;">
                        <div style="display:grid; grid-template-columns:100px 1fr; gap:8px; font-size:0.85rem;">
                            <span style="color:#6b7280;">IBAN:</span>
                            <span style="font-weight:700; font-family:monospace; letter-spacing:1px;" id="betaal-iban">${iban}</span>
                            <span style="color:#6b7280;">Naam:</span>
                            <span style="font-weight:600;">${aanvraag.tenaamstelling || aanvraag.ambassadeur_naam}</span>
                            <span style="color:#6b7280;">Bedrag:</span>
                            <span style="font-weight:600;">â‚¬${aanvraag.bedrag || 100},00</span>
                            <span style="color:#6b7280;">Omschrijving:</span>
                            <span style="font-weight:600;">Lief & Leed potje ${aanvraag.straat}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; justify-content:center;">
                        <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${(aanvraag.iban||'').replace(/\\s/g,'')}'); showToast('IBAN gekopieerd!','success');">ğŸ“‹ Kopieer IBAN</button>
                        <button class="btn btn-secondary" onclick="closeAllModals();">Sluiten</button>
                    </div>
                    <p style="text-align:center; font-size:0.75rem; color:#9ca3af; margin-top:12px;">Maak de betaling over via je bank-app. Vergeet niet de omschrijving toe te voegen.</p>
                `);
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis bij het toewijzen', 'error');
                if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; btn.textContent = 'âœ… Toewijzen'; }
            }
        }
        
        // Afwijzen
        function handleAfwijzen(id) {
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            openModal('âŒ Aanvraag afwijzen', `
                <p class="confirm-message">Weet je zeker dat je de aanvraag van <strong>${aanvraag.ambassadeur_naam}</strong> (${aanvraag.straat}) wilt afwijzen?</p>
                <div class="detail-section">
                    <h4>Doel van de aanvraag</h4>
                    <p>${aanvraag.doel || '-'}</p>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label style="font-size: 0.85rem;">Reden voor afwijzing <span class="required">*</span></label>
                    <textarea id="afwijzing-reden" rows="3" placeholder="Geef een reden op voor de afwijzing..." 
                              style="width: 100%; padding: 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.88rem; resize: vertical;"></textarea>
                    <span class="field-hint">Deze reden wordt meegestuurd in de email naar de aanvrager.</span>
                </div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-secondary" id="btn-confirm-afwijzen" onclick="confirmAfwijzen('${id}')" style="background: #fee2e2; color: #991b1b; border-color: #fecaca;">âŒ Afwijzen</button>
            `);
        }
        
        async function confirmAfwijzen(id) {
            const reden = document.getElementById('afwijzing-reden')?.value?.trim();
            if (!reden) {
                document.getElementById('afwijzing-reden').classList.add('field-error');
                showToast('Vul een reden voor afwijzing in', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-confirm-afwijzen');
            if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; btn.textContent = 'Bezig...'; }
            
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            try {
                // 1. Update status in Supabase
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('aanvragen')
                        .update({ status: 'afgewezen', afwijzing_reden: reden, updated_at: new Date().toISOString(), laatst_bewerkt_door: getAdminNaam() })
                        .eq('id', id);
                    if (error) throw error;
                }
                
                // 2. Send notification email
                try {
                    await fetch('/.netlify/functions/notify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'afwijzing',
                            data: {
                                ambassadeur_naam: aanvraag.ambassadeur_naam,
                                straat: aanvraag.straat,
                                doel: aanvraag.doel,
                                email: aanvraag.email,
                                reden: reden
                            }
                        })
                    });
                } catch (emailErr) {
                    console.error('Email error (non-blocking):', emailErr);
                }
                
                closeAllModals();
                showToast(`Aanvraag van ${aanvraag.ambassadeur_naam} is afgewezen`, 'info');
                await loadAanvragen();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis bij het afwijzen', 'error');
                if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; btn.textContent = 'âŒ Afwijzen'; }
            }
        }
        
        // Meer informatie vragen (aanvraag)
        function handleMeerInfoAanvraag(id) {
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            openModal('â„¹ï¸ Meer informatie vragen', `
                <p class="confirm-message">Stuur een verzoek om meer informatie naar <strong>${aanvraag.ambassadeur_naam}</strong> over de aanvraag voor <strong>${aanvraag.straat}</strong>.</p>
                <div class="detail-section">
                    <h4>Doel van de aanvraag</h4>
                    <p>${aanvraag.doel || '-'}</p>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label style="font-size: 0.85rem;">Welke informatie heb je nodig? <span class="required">*</span></label>
                    <textarea id="meer-info-vraag" rows="3" placeholder="Bijv. Kun je meer vertellen over het doel van de besteding? Of: Graag een specificatie van de kosten..."
                              style="width: 100%; padding: 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.88rem; resize: vertical;"></textarea>
                    <span class="field-hint">Dit wordt meegestuurd in de email naar de aanvrager.</span>
                </div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-primary" id="btn-confirm-meer-info" onclick="confirmMeerInfoAanvraag('${id}')" style="background: #e0f2fe; color: #0369a1; border-color: #bae6fd;">â„¹ï¸ Verstuur</button>
            `);
        }
        
        async function confirmMeerInfoAanvraag(id) {
            const vraag = document.getElementById('meer-info-vraag')?.value?.trim();
            if (!vraag) {
                document.getElementById('meer-info-vraag').classList.add('field-error');
                showToast('Vul in welke informatie je nodig hebt', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-confirm-meer-info');
            if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; btn.textContent = 'Bezig...'; }
            
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            try {
                // 1. Update status in Supabase
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('aanvragen')
                        .update({ status: 'info_gevraagd', updated_at: new Date().toISOString(), laatst_bewerkt_door: getAdminNaam() })
                        .eq('id', id);
                    if (error) throw error;
                }
                
                // 2. Send email
                try {
                    await fetch('/.netlify/functions/notify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'meer_info_aanvraag',
                            data: {
                                ambassadeur_naam: aanvraag.ambassadeur_naam,
                                straat: aanvraag.straat,
                                doel: aanvraag.doel,
                                email: aanvraag.email,
                                vraag: vraag
                            }
                        })
                    });
                } catch (emailErr) {
                    console.error('Email error (non-blocking):', emailErr);
                }
                
                closeAllModals();
                showToast(`Verzoek om meer informatie verstuurd naar ${aanvraag.ambassadeur_naam}`, 'success');
                await loadAanvragen();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis', 'error');
                if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; btn.textContent = 'â„¹ï¸ Verstuur'; }
            }
        }
        
        // =====================
        // AANMELDINGEN ACTIONS
        // =====================
        
        function handleApproveAanmelding(id) {
            const aanmelding = aanmeldingenData.find(a => a.id === id);
            if (!aanmelding) return;
            
            openModal('âœ… Aanmelding goedkeuren', `
                <p class="confirm-message">Wil je <strong>${aanmelding.naam}</strong> goedkeuren als straatambassadeur voor <strong>${aanmelding.straat}</strong>?</p>
                <div class="detail-grid">
                    <div class="detail-field">
                        <span class="detail-label">Naam</span>
                        <span class="detail-value">${aanmelding.naam}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-label">Straat</span>
                        <span class="detail-value">${aanmelding.straat}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-label">Telefoon</span>
                        <span class="detail-value">${aanmelding.telefoon || '-'}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-label">Email</span>
                        <span class="detail-value">${aanmelding.email || '-'}</span>
                    </div>
                </div>
                <div class="confirm-warning">
                    <span>â„¹ï¸</span>
                    <span>${aanmelding.naam} wordt automatisch toegevoegd aan de ambassadeurslijst en ontvangt een welkomstmail.</span>
                </div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-primary" id="btn-confirm-approve" onclick="confirmApproveAanmelding('${id}')">âœ… Goedkeuren</button>
            `);
        }
        
        async function confirmApproveAanmelding(id) {
            const btn = document.getElementById('btn-confirm-approve');
            if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; btn.textContent = 'Bezig...'; }
            
            const aanmelding = aanmeldingenData.find(a => a.id === id);
            if (!aanmelding) return;
            
            try {
                if (window.supabaseClient) {
                    // Add as ambassadeur
                    await window.supabaseClient.from('ambassadeurs').insert([{
                        naam: aanmelding.naam,
                        straat: aanmelding.straat,
                        telefoon: aanmelding.telefoon,
                        email: aanmelding.email,
                        actief: true
                    }]);
                    
                    // Update aanmelding status
                    await window.supabaseClient.from('aanmeldingen')
                        .update({ status: 'goedgekeurd', laatst_bewerkt_door: getAdminNaam() })
                        .eq('id', id);
                }
                
                // Send welcome email
                try {
                    await fetch('/.netlify/functions/notify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'aanmelding_goedgekeurd',
                            data: {
                                naam: aanmelding.naam,
                                straat: aanmelding.straat,
                                telefoon: aanmelding.telefoon,
                                email: aanmelding.email
                            }
                        })
                    });
                } catch (emailErr) {
                    console.error('Email error (non-blocking):', emailErr);
                }
                
                closeAllModals();
                showToast(`${aanmelding.naam} is toegevoegd als ambassadeur! ğŸ‰`, 'success', 5000);
                await loadAllData();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis bij het goedkeuren', 'error');
                if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; btn.textContent = 'âœ… Goedkeuren'; }
            }
        }
        
        function handleRejectAanmelding(id) {
            const aanmelding = aanmeldingenData.find(a => a.id === id);
            if (!aanmelding) return;
            
            openModal('âŒ Aanmelding afwijzen', `
                <p class="confirm-message">Weet je zeker dat je de aanmelding van <strong>${aanmelding.naam}</strong> (${aanmelding.straat}) wilt afwijzen?</p>
                <div class="form-group" style="margin-top: 16px;">
                    <label style="font-size: 0.85rem;">Reden voor afwijzing (optioneel)</label>
                    <textarea id="aanmelding-afwijzing-reden" rows="3" placeholder="Geef eventueel een reden op..." 
                              style="width: 100%; padding: 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.88rem; resize: vertical;"></textarea>
                </div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-secondary" id="btn-confirm-reject-aanmelding" onclick="confirmRejectAanmelding('${id}')" style="background: #fee2e2; color: #991b1b; border-color: #fecaca;">âŒ Afwijzen</button>
            `);
        }
        
        async function confirmRejectAanmelding(id) {
            const btn = document.getElementById('btn-confirm-reject-aanmelding');
            if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; }
            
            const aanmelding = aanmeldingenData.find(a => a.id === id);
            if (!aanmelding) return;
            const reden = document.getElementById('aanmelding-afwijzing-reden')?.value?.trim() || '';
            
            try {
                if (window.supabaseClient) {
                    await window.supabaseClient.from('aanmeldingen')
                        .update({ status: 'afgewezen', laatst_bewerkt_door: getAdminNaam() })
                        .eq('id', id);
                }
                
                // Send rejection email
                if (aanmelding.email) {
                    try {
                        await fetch('/.netlify/functions/notify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'aanmelding_afgewezen',
                                data: {
                                    naam: aanmelding.naam,
                                    straat: aanmelding.straat,
                                    email: aanmelding.email,
                                    reden: reden
                                }
                            })
                        });
                    } catch (emailErr) {
                        console.error('Email error (non-blocking):', emailErr);
                    }
                }
                
                closeAllModals();
                showToast(`Aanmelding van ${aanmelding.naam} is afgewezen`, 'info');
                await loadAanmeldingen();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis bij het afwijzen', 'error');
                if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; }
            }
        }
        
        // Meer informatie vragen (aanmelding)
        function handleMeerInfoAanmelding(id) {
            const aanmelding = aanmeldingenData.find(a => a.id === id);
            if (!aanmelding) return;
            
            openModal('â„¹ï¸ Meer informatie vragen', `
                <p class="confirm-message">Stuur een verzoek om meer informatie naar <strong>${aanmelding.naam}</strong> over de aanmelding als ambassadeur voor <strong>${aanmelding.straat}</strong>.</p>
                <div class="form-group" style="margin-top: 16px;">
                    <label style="font-size: 0.85rem;">Welke informatie heb je nodig? <span class="required">*</span></label>
                    <textarea id="meer-info-aanmelding-vraag" rows="3" placeholder="Bijv. In welk deel van de straat woon je? Of: Kun je meer vertellen over je motivatie?"
                              style="width: 100%; padding: 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.88rem; resize: vertical;"></textarea>
                    <span class="field-hint">Dit wordt meegestuurd in de email naar de aanmelder.</span>
                </div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-primary" id="btn-confirm-meer-info-aanmelding" onclick="confirmMeerInfoAanmelding('${id}')" style="background: #e0f2fe; color: #0369a1; border-color: #bae6fd;">â„¹ï¸ Verstuur</button>
            `);
        }
        
        async function confirmMeerInfoAanmelding(id) {
            const vraag = document.getElementById('meer-info-aanmelding-vraag')?.value?.trim();
            if (!vraag) {
                document.getElementById('meer-info-aanmelding-vraag').classList.add('field-error');
                showToast('Vul in welke informatie je nodig hebt', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-confirm-meer-info-aanmelding');
            if (btn) { btn.classList.add('btn-loading'); btn.disabled = true; btn.textContent = 'Bezig...'; }
            
            const aanmelding = aanmeldingenData.find(a => a.id === id);
            if (!aanmelding) return;
            
            try {
                // 1. Update status
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('aanmeldingen')
                        .update({ status: 'info_gevraagd', laatst_bewerkt_door: getAdminNaam() })
                        .eq('id', id);
                    if (error) throw error;
                }
                
                // 2. Send email
                if (aanmelding.email) {
                    try {
                        await fetch('/.netlify/functions/notify', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                type: 'meer_info_aanmelding',
                                data: {
                                    naam: aanmelding.naam,
                                    straat: aanmelding.straat,
                                    email: aanmelding.email,
                                    vraag: vraag
                                }
                            })
                        });
                    } catch (emailErr) {
                        console.error('Email error (non-blocking):', emailErr);
                    }
                }
                
                closeAllModals();
                showToast(`Verzoek om meer informatie verstuurd naar ${aanmelding.naam}`, 'success');
                await loadAanmeldingen();
            } catch (error) {
                console.error('Error:', error);
                showToast('Er ging iets mis', 'error');
                if (btn) { btn.classList.remove('btn-loading'); btn.disabled = false; btn.textContent = 'â„¹ï¸ Verstuur'; }
            }
        }
        
        // =====================
        // DETAIL MODAL
        // =====================
        function showDetail(id) {
            const a = aanvragenData.find(x => x.id === id);
            if (!a) return;
            
            const statusColors = {
                'nieuw': '#6366f1',
                'in_behandeling': '#f59e0b',
                'uitgekeerd': '#10b981',
                'afgewezen': '#ef4444'
            };
            
            const bodyHtml = `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <span class="status-badge ${a.status}" style="font-size: 0.75rem; padding: 4px 12px;">${formatStatus(a.status)}</span>
                    <span style="font-size: 0.75rem; color: var(--gray-400);">Aangevraagd op ${formatDateTime(a.created_at)}</span>
                </div>
                
                <div class="detail-grid">
                    <div class="detail-field">
                        <span class="detail-label">Naam</span>
                        <span class="detail-value">${a.ambassadeur_naam || '-'}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-label">Straat</span>
                        <span class="detail-value">${a.straat || '-'}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-label">Telefoon</span>
                        <span class="detail-value">${a.telefoon || '-'}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-label">E-mail</span>
                        <span class="detail-value">${a.email || '-'}</span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>ğŸ¯ Doel</h4>
                    <p>${a.doel || '-'}</p>
                </div>
                
                <div class="detail-grid">
                    <div class="detail-field">
                        <span class="detail-label">IBAN</span>
                        <span class="detail-value" style="font-family: monospace;">${a.iban ? a.iban : (a.uitbetaald ? '<em style="color:#9ca3af;font-style:italic;">(IBAN verwijderd - AVG)</em>' : '-')}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-label">Tenaamstelling</span>
                        <span class="detail-value">${a.tenaamstelling || '-'}</span>
                    </div>
                </div>
                
                ${a.eerder_ontvangen ? `
                <div class="detail-section" style="border-left-color: #f59e0b;">
                    <h4>ğŸ“… Eerder potje ontvangen</h4>
                    <p><strong>Wanneer:</strong> ${a.eerder_maand}/${a.eerder_jaar}</p>
                    <p><strong>Waarvoor:</strong> ${a.vorig_gebruik || '-'}</p>
                </div>
                ` : `
                <div class="detail-section" style="border-left-color: #10b981;">
                    <h4>âœ¨ Eerste aanvraag</h4>
                    <p>Dit is de eerste potje aanvraag van deze ambassadeur.</p>
                </div>
                `}
                
                <div class="detail-grid">
                    <div class="detail-field">
                        <span class="detail-label">Administratie</span>
                        <span class="detail-value">${a.administratie === 'zelf' ? 'ğŸ“‹ Bewaart zelf' : 'ğŸ“¤ Levert aan bij kerngroep'}</span>
                    </div>
                    <div class="detail-field">
                        <span class="detail-label">Bedrag</span>
                        <span class="detail-value" style="font-size: 1.1rem; color: var(--status-goedgekeurd);">â‚¬${a.bedrag || 100}</span>
                    </div>
                </div>
                
                ${a.afrekening_overzicht ? `
                <div class="detail-section" style="border-left-color: #f59e0b; background: #fffbeb;">
                    <h4>ğŸ“‹ Afrekening vorig potje</h4>
                    <table style="width:100%;border-collapse:collapse;font-size:0.82rem;margin:8px 0;">
                        <tr style="background:#fef3c7;"><th style="text-align:left;padding:4px 8px;border-bottom:1px solid #fcd34d;">Nr.</th><th style="text-align:left;padding:4px 8px;border-bottom:1px solid #fcd34d;">Omschrijving</th><th style="text-align:right;padding:4px 8px;border-bottom:1px solid #fcd34d;">Bedrag</th></tr>
                        ${(() => { try { return JSON.parse(a.afrekening_overzicht).map(r => '<tr><td style="padding:3px 8px;">' + (r.nr||'') + '</td><td style="padding:3px 8px;">' + (r.omschrijving||'') + '</td><td style="padding:3px 8px;text-align:right;">â‚¬ ' + (r.bedrag||'') + '</td></tr>').join(''); } catch(e) { return '<tr><td colspan="3" style="padding:4px 8px;">' + a.afrekening_overzicht + '</td></tr>'; }})()}
                    </table>
                    ${a.afrekening_totaal ? '<div style="text-align:right;font-weight:700;font-size:0.9rem;color:#92400e;">Totaal: â‚¬ ' + a.afrekening_totaal + '</div>' : ''}
                    ${a.bonnetjes_urls ? '<div style="margin-top:8px;"><strong style="font-size:0.8rem;">ğŸ“ Bijlagen:</strong><div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;">' + (() => { try { return JSON.parse(a.bonnetjes_urls).map(b => '<a href="' + b.url + '" target="_blank" style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:#fef3c7;border:1px solid #fcd34d;border-radius:6px;font-size:0.75rem;color:#92400e;text-decoration:none;">ğŸ“ ' + b.name + '</a>').join(''); } catch(e) { return ''; }})() + '</div></div>' : ''}
                </div>
                ` : ''}

                <div style="margin-top:12px;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;">
                    <h4 style="font-size:0.82rem;color:#374151;margin-bottom:8px;">ğŸ“Œ Status tracking</h4>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.85rem;margin-bottom:6px;">
                        <input type="checkbox" ${a.uitbetaald ? 'checked' : ''} onchange="updateTracking('${a.id}','uitbetaald',this.checked)" style="width:18px;height:18px;accent-color:#10b981;">
                        <span>ğŸ’³ Uitbetaald (â‚¬${a.bedrag || 100} overgemaakt)</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.85rem;">
                        <input type="checkbox" ${a.onedrive_archief ? 'checked' : ''} onchange="updateTracking('${a.id}','onedrive_archief',this.checked)" style="width:18px;height:18px;accent-color:#3b82f6;">
                        <span>ğŸ“ OneDrive archief (bonnetjes opgeslagen)</span>
                    </label>
                </div>

                ${a.ervaring ? `
                <div class="detail-section" style="border-left-color: #ec4899;">
                    <h4>ğŸ’¬ Ervaring / Verhaal</h4>
                    <p>${a.ervaring}</p>
                </div>
                ` : ''}
                
                ${a.afwijzing_reden ? `
                <div class="detail-section" style="border-left-color: #ef4444; background: #fef2f2;">
                    <h4>âŒ Reden afwijzing</h4>
                    <p>${a.afwijzing_reden}</p>
                </div>
                ` : ''}
            `;
            
            // Build footer buttons based on status
            let footerBtns = `<button class="btn btn-secondary" onclick="printAanvraag('${a.id}')">ğŸ–¨ï¸ Printen</button>`;
            
            if (a.status === 'nieuw') {
                footerBtns += `
                    <button class="btn btn-gold" onclick="closeAllModals(); handleInBehandeling('${a.id}');">â³ In behandeling</button>
                    <button class="btn" onclick="closeAllModals(); handleMeerInfoAanvraag('${a.id}');" style="background: #e0f2fe; color: #0369a1; border-color: #bae6fd;">â„¹ï¸ Meer info</button>
                    <button class="btn btn-primary" onclick="closeAllModals(); handleToewijzen('${a.id}');">âœ… Toewijzen</button>
                `;
            } else if (a.status === 'in_behandeling' || a.status === 'info_gevraagd') {
                footerBtns += `
                    <button class="btn" onclick="closeAllModals(); handleMeerInfoAanvraag('${a.id}');" style="background: #e0f2fe; color: #0369a1; border-color: #bae6fd;">â„¹ï¸ Meer info</button>
                    <button class="btn btn-primary" onclick="closeAllModals(); handleToewijzen('${a.id}');">âœ… Toewijzen</button>
                    <button class="btn btn-secondary" onclick="closeAllModals(); handleAfwijzen('${a.id}');" style="background: #fee2e2; color: #991b1b;">âŒ Afwijzen</button>
                `;
            }
            
            openModal('ğŸ“‹ Aanvraag Details', bodyHtml, footerBtns, { maxWidth: '560px' });
        }
        
        function printAanvraag(id) {
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="nl">
                <head>
                    <meta charset="UTF-8">
                    <title>Aanvraag - ${aanvraag.ambassadeur_naam}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 700px; margin: 40px auto; padding: 20px; color: #333; }
                        h1 { color: #1a2744; font-size: 1.4rem; border-bottom: 3px solid #f4c542; padding-bottom: 10px; }
                        .section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2855a3; }
                        .section h3 { color: #1a2744; font-size: 0.95rem; margin: 0 0 10px 0; text-transform: uppercase; }
                        .row { display: flex; gap: 20px; margin-bottom: 8px; }
                        .row > div { flex: 1; }
                        .label { font-size: 0.8rem; color: #6b7280; text-transform: uppercase; }
                        .value { font-weight: 600; font-size: 0.95rem; }
                        .status { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; }
                        .status.nieuw { background: #e0e7ff; color: #3730a3; }
                        .status.in_behandeling { background: #fef3c7; color: #92400e; }
                        .status.uitgekeerd { background: #d1fae5; color: #065f46; }
                        .status.afgewezen { background: #fee2e2; color: #991b1b; }
                        .footer { margin-top: 30px; text-align: center; color: #9ca3af; font-size: 0.8rem; border-top: 1px solid #e5e7eb; padding-top: 15px; }
                        .signature { margin-top: 40px; display: flex; gap: 40px; }
                        .signature > div { flex: 1; border-top: 1px solid #333; padding-top: 8px; font-size: 0.85rem; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>ğŸ§¡ Lief & Leed Potje â€” Aanvraag</h1>
                    <div class="section">
                        <h3>Aanvrager</h3>
                        <div class="row"><div><span class="label">Naam</span><br><span class="value">${aanvraag.ambassadeur_naam}</span></div><div><span class="label">Straat</span><br><span class="value">${aanvraag.straat}</span></div></div>
                        <div class="row"><div><span class="label">Telefoon</span><br><span class="value">${aanvraag.telefoon || '-'}</span></div><div><span class="label">E-mail</span><br><span class="value">${aanvraag.email || '-'}</span></div></div>
                    </div>
                    <div class="section">
                        <h3>Aanvraag</h3>
                        <div><span class="label">Doel</span><br><span class="value">${aanvraag.doel || '-'}</span></div>
                        <div style="margin-top: 10px;"><span class="label">Bedrag</span><br><span class="value">â‚¬${aanvraag.bedrag || 100}</span></div>
                        <div style="margin-top: 10px;"><span class="label">Status</span><br><span class="status ${aanvraag.status}">${formatStatus(aanvraag.status)}</span></div>
                    </div>
                    ${aanvraag.eerder_ontvangen ? `<div class="section"><h3>Eerder potje ontvangen</h3><div class="row"><div><span class="label">Wanneer</span><br><span class="value">${aanvraag.eerder_maand}/${aanvraag.eerder_jaar}</span></div><div><span class="label">Waarvoor</span><br><span class="value">${aanvraag.vorig_gebruik || '-'}</span></div></div></div>` : ''}
                    <div class="section"><h3>Betaalgegevens</h3><div class="row"><div><span class="label">IBAN</span><br><span class="value">${aanvraag.iban || '-'}</span></div><div><span class="label">Tenaamstelling</span><br><span class="value">${aanvraag.tenaamstelling || '-'}</span></div></div></div>
                    <div class="section"><h3>Administratie</h3><div><span class="value">${aanvraag.administratie === 'zelf' ? 'Bewaart zelf de administratie (min. 3 jaar)' : 'Levert administratie aan bij kerngroep'}</span></div></div>
                    ${aanvraag.afrekening_overzicht ? `<div class="section"><h3>ğŸ“‹ Afrekening vorig potje</h3><div><table style="width:100%;border-collapse:collapse;font-size:0.85rem;"><tr style="background:#f0f7ff;"><th style="text-align:left;padding:4px 8px;border-bottom:1px solid #93c5fd;">Nr.</th><th style="text-align:left;padding:4px 8px;border-bottom:1px solid #93c5fd;">Omschrijving</th><th style="text-align:right;padding:4px 8px;border-bottom:1px solid #93c5fd;">Bedrag</th></tr>${(() => { try { return JSON.parse(aanvraag.afrekening_overzicht).map(r => '<tr><td style="padding:3px 8px;">' + (r.nr||'') + '</td><td style="padding:3px 8px;">' + (r.omschrijving||'') + '</td><td style="padding:3px 8px;text-align:right;">' + (r.bedrag||'') + '</td></tr>').join(''); } catch(e) { return '<tr><td colspan="3" style="padding:4px 8px;">' + aanvraag.afrekening_overzicht + '</td></tr>'; }})()}</table>${aanvraag.afrekening_totaal ? '<div style="text-align:right;font-weight:700;margin-top:4px;">Totaal: â‚¬ ' + aanvraag.afrekening_totaal + '</div>' : ''}</div></div>` : ''}
                    ${aanvraag.bonnetjes_urls ? `<div class="section"><h3>ğŸ“ Bonnetjes</h3><div style="display:flex;flex-wrap:wrap;gap:8px;">${(() => { try { return JSON.parse(aanvraag.bonnetjes_urls).map(b => '<a href="' + b.url + '" target="_blank" style="display:inline-flex;align-items:center;gap:4px;padding:6px 12px;background:#e8f4fd;border-radius:6px;font-size:0.8rem;color:#1a2744;text-decoration:none;">ğŸ“ ' + b.name + '</a>').join(''); } catch(e) { return '-'; }})()}</div></div>` : ''}
                    ${aanvraag.ervaring ? `<div class="section"><h3>Gedeelde ervaring</h3><div><span class="value">${aanvraag.ervaring}</span></div></div>` : ''}
                    <div class="signature"><div>Handtekening ambassadeur</div><div>Handtekening kerngroep</div></div>
                    <div class="footer">Straatambassadeurs Vathorst & Hooglanderveen â€” Van de straat, voor de straat ğŸ§¡<br>Aanvraag ingediend op: ${formatDateTime(aanvraag.created_at)} | Geprint op: ${new Date().toLocaleString('nl-NL')}</div>
                </body></html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
        }
        
        // Update Stats
        async function updateTracking(id, field, value) {
            try {
                if (window.supabaseClient) {
                    const update = {};
                    update[field] = value;
                    update.updated_at = new Date().toISOString();
                    update.laatst_bewerkt_door = getAdminNaam();
                    // AVG: sla uitbetaald_datum op wanneer uitbetaald wordt aangevinkt
                    if (field === 'uitbetaald') {
                        update.uitbetaald_datum = value ? new Date().toISOString() : null;
                    }
                    const { error } = await window.supabaseClient
                        .from('aanvragen')
                        .update(update)
                        .eq('id', id);
                    if (error) throw error;
                    // Update local data
                    const aanvraag = aanvragenData.find(a => a.id === id);
                    if (aanvraag) {
                        aanvraag[field] = value;
                        if (field === 'uitbetaald') {
                            aanvraag.uitbetaald_datum = value ? new Date().toISOString() : null;
                        }
                    }
                    showToast(value ? 'âœ… ' + (field === 'uitbetaald' ? 'Uitbetaald' : 'OneDrive archief') + ' aangevinkt' : 'â¬œ ' + (field === 'uitbetaald' ? 'Uitbetaald' : 'OneDrive archief') + ' uitgevinkt', 'success');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Fout bij opslaan', 'error');
            }
        }

        // AVG: IBAN automatisch verwijderen 30 dagen na uitbetaling
        async function cleanupExpiredIBANs() {
            if (!window.supabaseClient) return;
            try {
                const dertigDagenGeleden = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
                const { data, error } = await window.supabaseClient
                    .from('aanvragen')
                    .select('id, iban, uitbetaald_datum')
                    .eq('uitbetaald', true)
                    .not('iban', 'is', null)
                    .neq('iban', '')
                    .not('uitbetaald_datum', 'is', null)
                    .lt('uitbetaald_datum', dertigDagenGeleden);
                if (error) throw error;
                if (!data || data.length === 0) return;
                for (const aanvraag of data) {
                    const { error: updateError } = await window.supabaseClient
                        .from('aanvragen')
                        .update({ iban: null, updated_at: new Date().toISOString() })
                        .eq('id', aanvraag.id);
                    if (!updateError) {
                        console.log('IBAN verwijderd voor aanvraag ' + aanvraag.id + ' (>30 dagen na uitbetaling)');
                    }
                }
            } catch (error) {
                console.error('AVG IBAN cleanup error:', error);
            }
        }

        function updateStats() {
            document.getElementById('stat-nieuw').textContent = aanvragenData.filter(a => a.status === 'nieuw').length;
            document.getElementById('stat-behandeling').textContent = aanvragenData.filter(a => a.status === 'in_behandeling').length;
            document.getElementById('stat-uitgekeerd').textContent = aanvragenData.filter(a => a.status === 'uitgekeerd').length;
            document.getElementById('stat-ambassadeurs').textContent = ambassadeursData.filter(a => a.actief).length;
        }
        
        // Helpers
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit' });
        }
        
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('nl-NL');
        }
        
        function formatStatus(status) {
            const labels = {
                'nieuw': 'Nieuw',
                'in_behandeling': 'In behandeling',
                'info_gevraagd': 'Info gevraagd',
                'goedgekeurd': 'Goedgekeurd',
                'uitgekeerd': 'Uitgekeerd',
                'afgewezen': 'Afgewezen'
            };
            return labels[status] || status;
        }
        
        function truncate(str, len) {
            if (!str) return '-';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
        
        // Legacy updateStatus for backward compat
        async function updateStatus(id, status) {
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('aanvragen')
                        .update({ status, updated_at: new Date().toISOString() })
                        .eq('id', id);
                    if (error) throw error;
                }
                await loadAanvragen();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // =====================
        // POTJES FUNCTIONALITY
        // =====================
        
        function initPotjesJaarFilter() {
            const select = document.getElementById('potjes-jaar');
            if (!select) return;
            const currentYear = new Date().getFullYear();
            select.innerHTML = '';
            for (let y = currentYear; y >= currentYear - 3; y--) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                select.appendChild(opt);
            }
        }
        
        function populateAmbassadeurDropdown() {
            const select = document.getElementById('potje-ambassadeur');
            if (!select) return;
            const active = ambassadeursData.filter(a => a.actief);
            select.innerHTML = '<option value="">Kies ambassadeur...</option>' +
                active.map(a => `<option value="${a.id}">${a.naam} (${a.straat || ''})</option>`).join('');
        }
        
        function getSelectedYear() {
            const el = document.getElementById('potjes-jaar');
            return el ? parseInt(el.value) || new Date().getFullYear() : new Date().getFullYear();
        }
        
        // ===== AFREKENINGEN =====
        async function loadAfrekeningen() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('potje_afrekeningen')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                const tbody = document.getElementById('afrekeningen-body');
                if (!tbody) return;
                tbody.innerHTML = (data || []).map(a => {
                    const datum = new Date(a.created_at).toLocaleDateString('nl-NL');
                    const keuzeLabels = { doorgaan: 'ğŸ”„ Doorgaan', nieuw_potje: 'ğŸ†• Nieuw potje', stoppen: 'ğŸ›‘ Stoppen' };
                    const keuze = keuzeLabels[a.keuze] || a.keuze || '-';
                    let bonnetjes = [];
                    try { bonnetjes = JSON.parse(a.bonnetjes_urls || '[]'); } catch(e) {}
                    let bonregels = [];
                    try { bonregels = JSON.parse(a.afrekening_overzicht || '[]'); } catch(e) {}
                    return `<tr>
                        <td>${a.ambassadeur_naam || '-'}</td>
                        <td>${a.straat || '-'}</td>
                        <td><strong>â‚¬ ${a.afrekening_totaal || '0'}</strong></td>
                        <td>${keuze}</td>
                        <td>
                            <label style="font-size:0.75rem;cursor:pointer;"><input type="checkbox" ${a.uitbetaald ? 'checked' : ''} onchange="updateAfrekeningTracking('${a.id}','uitbetaald',this.checked)"> ğŸ’³</label>
                            <label style="font-size:0.75rem;cursor:pointer;margin-left:4px;"><input type="checkbox" ${a.onedrive_archief ? 'checked' : ''} onchange="updateAfrekeningTracking('${a.id}','onedrive_archief',this.checked)"> ğŸ“</label>
                        </td>
                        <td style="font-size:0.75rem;">${datum}</td>
                        <td><button class="btn btn-small" onclick="showAfrekeningDetail('${a.id}')">ğŸ“‹ Details</button></td>
                    </tr>`;
                }).join('');
            } catch(e) { console.error('Afrekeningen error:', e); }
        }

        async function updateAfrekeningTracking(id, field, value) {
            try {
                const { error } = await window.supabaseClient
                    .from('potje_afrekeningen')
                    .update({ [field]: value })
                    .eq('id', id);
                if (error) throw error;
                showToast(field === 'uitbetaald' ? 'ğŸ’³ Uitbetaald bijgewerkt' : 'ğŸ“ Archief bijgewerkt', 'success');
            } catch(e) { showToast('Fout bij opslaan', 'error'); }
        }

        async function showAfrekeningDetail(id) {
            try {
                const { data, error } = await window.supabaseClient
                    .from('potje_afrekeningen')
                    .select('*')
                    .eq('id', id)
                    .single();
                if (error) throw error;
                let bonregels = [];
                try { bonregels = JSON.parse(data.afrekening_overzicht || '[]'); } catch(e) {}
                let bonnetjes = [];
                try { bonnetjes = JSON.parse(data.bonnetjes_urls || '[]'); } catch(e) {}
                const keuzeLabels = { doorgaan: 'ğŸ”„ Doorgaan met huidig potje', nieuw_potje: 'ğŸ†• Nieuw potje aanvragen', stoppen: 'ğŸ›‘ Stoppen' };
                const html = `
                    <p><strong>Straat:</strong> ${data.straat || '-'}<br>
                    <strong>Email:</strong> ${data.email || '-'}<br>
                    <strong>Telefoon:</strong> ${data.telefoon || '-'}<br>
                    <strong>Keuze:</strong> ${keuzeLabels[data.keuze] || data.keuze || '-'}<br>
                    <strong>Datum:</strong> ${new Date(data.created_at).toLocaleDateString('nl-NL')}</p>
                    <h4>Bonregels</h4>
                    <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                        <tr style="background:#f0f4ff;"><th style="padding:6px;text-align:left;">Nr</th><th style="text-align:left;">Omschrijving</th><th style="text-align:right;">Bedrag</th></tr>
                        ${bonregels.map(b => `<tr><td style="padding:4px 6px;">${b.nr}</td><td>${b.omschrijving}</td><td style="text-align:right;">â‚¬ ${b.bedrag}</td></tr>`).join('')}
                        <tr style="font-weight:700;border-top:2px solid #1a2744;"><td colspan="2" style="padding:6px;">Totaal</td><td style="text-align:right;">â‚¬ ${data.afrekening_totaal}</td></tr>
                    </table>
                    ${bonnetjes.length ? `<h4 style="margin-top:12px;">ğŸ“ Bijlagen (${bonnetjes.length})</h4><ul>${bonnetjes.map(b => `<li><a href="${b.url}" target="_blank">${b.name}</a></li>`).join('')}</ul>` : '<p><em>Geen bijlagen</em></p>'}
                    <div style="margin-top:12px;display:flex;gap:8px;">
                        <label style="cursor:pointer;"><input type="checkbox" ${data.uitbetaald ? 'checked' : ''} onchange="updateAfrekeningTracking('${data.id}','uitbetaald',this.checked)"> ğŸ’³ Uitbetaald</label>
                        <label style="cursor:pointer;"><input type="checkbox" ${data.onedrive_archief ? 'checked' : ''} onchange="updateAfrekeningTracking('${data.id}','onedrive_archief',this.checked)"> ğŸ“ OneDrive archief</label>
                    </div>
                `;
                openModal(`ğŸ§¾ Afrekening â€” ${data.ambassadeur_naam}`, html, '', { maxWidth: '600px' });
            } catch(e) { console.error(e); showToast('Fout bij laden details', 'error'); }
        }

        async function loadPotjes() {
            if (!window.supabaseClient) return;
            const jaar = getSelectedYear();
            
            try {
                // Load toekenningen
                const { data: toekenningen, error: tErr } = await window.supabaseClient
                    .from('potje_toekenningen')
                    .select('*')
                    .eq('jaar', jaar);
                
                if (tErr) {
                    // Table doesn't exist yet
                    if (tErr.code === '42P01' || tErr.message?.includes('does not exist') || tErr.message?.includes('relation')) {
                        potjesTablesExist = false;
                        document.getElementById('potjes-error').classList.remove('hidden');
                        document.getElementById('potjes-content').style.display = 'none';
                        return;
                    }
                    throw tErr;
                }
                
                potjesTablesExist = true;
                document.getElementById('potjes-error').classList.add('hidden');
                document.getElementById('potjes-content').style.display = 'block';
                potjeToekenningenData = toekenningen || [];
                
                // Load uitgaven
                const { data: uitgaven, error: uErr } = await window.supabaseClient
                    .from('potje_uitgaven')
                    .select('*')
                    .eq('jaar', jaar)
                    .order('datum', { ascending: false });
                
                if (uErr) throw uErr;
                potjeUitgavenData = uitgaven || [];
                
                renderPotjes();
            } catch (error) {
                console.error('Potjes laden:', error);
                // Gracefully handle missing tables
                if (error.code === '42P01' || error.message?.includes('does not exist')) {
                    potjesTablesExist = false;
                    document.getElementById('potjes-error').classList.remove('hidden');
                    document.getElementById('potjes-content').style.display = 'none';
                }
            }
        }
        
        function renderPotjes() {
            const jaar = getSelectedYear();
            
            // Build per-ambassadeur overview (include ALL ambassadeurs, not just active)
            const overview = {};
            ambassadeursData.forEach(a => {
                overview[a.id] = { naam: a.naam, straat: a.straat || '', budget: 0, besteed: 0, actief: a.actief };
            });
            
            // Add budgets from toekenningen
            potjeToekenningenData.forEach(t => {
                if (!t.ambassadeur_id) return;
                if (!overview[t.ambassadeur_id]) {
                    overview[t.ambassadeur_id] = { naam: 'Onbekend', straat: '', budget: 0, besteed: 0, actief: false };
                }
                overview[t.ambassadeur_id].budget += parseFloat(t.bedrag) || 0;
            });
            
            // Add expenses
            potjeUitgavenData.forEach(u => {
                if (!u.ambassadeur_id) return;
                if (!overview[u.ambassadeur_id]) {
                    overview[u.ambassadeur_id] = { naam: 'Onbekend', straat: '', budget: 0, besteed: 0, actief: false };
                }
                overview[u.ambassadeur_id].besteed += parseFloat(u.bedrag) || 0;
            });
            
            // Calculate totals
            let totaalBudget = 0, totaalBesteed = 0;
            Object.values(overview).forEach(o => {
                totaalBudget += o.budget;
                totaalBesteed += o.besteed;
            });
            
            document.getElementById('potjes-totaal-budget').textContent = `â‚¬${totaalBudget.toFixed(0)}`;
            document.getElementById('potjes-totaal-besteed').textContent = `â‚¬${totaalBesteed.toFixed(0)}`;
            document.getElementById('potjes-totaal-resterend').textContent = `â‚¬${(totaalBudget - totaalBesteed).toFixed(0)}`;
            
            // Render per-ambassadeur
            const perAmbEl = document.getElementById('potjes-per-ambassadeur');
            const entries = Object.entries(overview).filter(([_, o]) => o.budget > 0 || o.besteed > 0);
            
            if (entries.length === 0) {
                perAmbEl.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 8px; font-size: 0.82rem;">Nog geen potjes toegekend voor ' + jaar + '. Voeg eerst een toekenning toe via de uitgaven of wijs budget toe.</p>';
            } else {
                perAmbEl.innerHTML = entries.map(([id, o]) => {
                    const resterend = o.budget - o.besteed;
                    const pct = o.budget > 0 ? Math.min((o.besteed / o.budget) * 100, 100) : 0;
                    const color = pct >= 100 ? '#ef4444' : pct >= 75 ? '#f59e0b' : '#10b981';
                    return `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--gray-100);">
                            <div style="flex: 1; min-width: 0;">
                                <strong style="font-size: 0.82rem;">${o.naam}</strong>
                                <span style="font-size: 0.72rem; color: var(--gray-400);"> Â· ${o.straat}</span>
                            </div>
                            <div style="width: 80px; background: var(--gray-100); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="width: ${pct}%; height: 100%; background: ${color}; border-radius: 4px;"></div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-600); white-space: nowrap; min-width: 120px; text-align: right;">
                                â‚¬${o.besteed.toFixed(0)} / â‚¬${o.budget.toFixed(0)} <span style="color: ${color};">(â‚¬${resterend.toFixed(0)})</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render expenses table
            const tbody = document.getElementById('potjes-uitgaven-tbody');
            if (potjeUitgavenData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px; color: var(--gray-400);">Geen uitgaven gevonden voor ' + jaar + '</td></tr>';
            } else {
                tbody.innerHTML = potjeUitgavenData.map(u => {
                    const amb = ambassadeursData.find(a => a.id === u.ambassadeur_id);
                    return `
                        <tr>
                            <td data-label="Datum">${u.datum ? new Date(u.datum).toLocaleDateString('nl-NL') : '-'}</td>
                            <td data-label="Ambassadeur"><strong>${amb ? amb.naam : 'Onbekend'}</strong></td>
                            <td data-label="Omschrijving">${u.omschrijving || '-'}</td>
                            <td data-label="Bedrag" style="font-weight: 600;">â‚¬${parseFloat(u.bedrag).toFixed(2)}</td>
                            <td data-label="Acties">
                                <button class="btn-icon btn-danger" onclick="deleteUitgave('${u.id}')" title="Verwijderen">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Set date input default
            const datumInput = document.getElementById('potje-datum');
            if (datumInput && !datumInput.value) {
                datumInput.value = new Date().toISOString().split('T')[0];
            }
        }
        
        async function addUitgave() {
            if (!potjesTablesExist) { alert('Potjes tabellen bestaan nog niet. Voer eerst de SQL migration uit.'); return; }
            
            const ambassadeurId = document.getElementById('potje-ambassadeur').value;
            const bedrag = document.getElementById('potje-bedrag').value;
            const omschrijving = document.getElementById('potje-omschrijving').value.trim();
            const datum = document.getElementById('potje-datum').value;
            const jaar = getSelectedYear();
            
            if (!ambassadeurId || !bedrag || !omschrijving || !datum) {
                alert('Vul alle velden in');
                return;
            }
            
            const btn = event?.target;
            disableBtn(btn, 'Opslaan...');
            
            try {
                // Check if ambassadeur has a toekenning for this year, if not create one
                const existing = potjeToekenningenData.find(t => t.ambassadeur_id === ambassadeurId);
                if (!existing) {
                    const { error: tErr } = await window.supabaseClient
                        .from('potje_toekenningen')
                        .insert([{ ambassadeur_id: ambassadeurId, jaar, bedrag: 100.00, status: 'actief' }]);
                    if (tErr) throw tErr;
                }
                
                const { error } = await window.supabaseClient
                    .from('potje_uitgaven')
                    .insert([{
                        ambassadeur_id: ambassadeurId,
                        jaar,
                        bedrag: parseFloat(bedrag),
                        omschrijving,
                        datum
                    }]);
                
                if (error) throw error;
                
                // Reset form
                document.getElementById('potje-bedrag').value = '';
                document.getElementById('potje-omschrijving').value = '';
                
                showToast('Uitgave opgeslagen âœ…', 'success');
                await loadPotjes();
            } catch (error) {
                console.error('Uitgave toevoegen:', error);
                showToast('Er ging iets mis bij het opslaan: ' + (error.message || 'onbekende fout'), 'error');
            } finally {
                enableBtn(btn);
            }
        }
        
        async function deleteUitgave(id) {
            if (!confirm('Weet je zeker dat je deze uitgave wilt verwijderen?')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('potje_uitgaven')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                showToast('Uitgave verwijderd', 'info');
                await loadPotjes();
            } catch (error) {
                console.error('Uitgave verwijderen:', error);
                showToast('Er ging iets mis bij het verwijderen: ' + (error.message || 'onbekende fout'), 'error');
            }
        }
        
        // =====================
        // NOTULEN FUNCTIONALITY
        // =====================
        
        async function loadNotulen() {
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('notulen')
                    .select('*')
                    .order('datum', { ascending: false });
                
                if (error) {
                    // Table doesn't exist - show static content only
                    if (error.code === '42P01' || error.message?.includes('does not exist')) {
                        notulenData = [];
                        renderNotulen();
                        return;
                    }
                    throw error;
                }
                
                notulenData = data || [];
                renderNotulen();
            } catch (error) {
                console.error('Notulen laden:', error);
                notulenData = [];
                renderNotulen();
            }
        }
        
        function renderNotulen() {
            const listEl = document.getElementById('notulen-list');
            
            if (notulenData.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 16px; font-size: 0.82rem;">Nog geen notulen in de database. Voeg er een toe via het formulier hierboven, of voer eerst de SQL migration uit.</p>';
                return;
            }
            
            listEl.innerHTML = notulenData.map(n => `
                <div class="info-section" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; gap: 8px;">
                    <div style="flex: 1; min-width: 0;">
                        <strong style="font-size: 0.85rem;">ğŸ“„ ${n.titel}</strong><br>
                        <span style="font-size: 0.75rem; color: var(--gray-500);">
                            ${n.datum ? new Date(n.datum).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' }) : ''}
                            ${n.aanwezig ? ' Â· Aanwezig: ' + n.aanwezig : ''}
                        </span>
                        ${n.samenvatting ? `<br><span style="font-size: 0.75rem; color: var(--gray-600); font-style: italic;">${truncate(n.samenvatting, 100)}</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 4px; flex-shrink: 0;">
                        ${n.bestand_url ? `<a href="${n.bestand_url}" target="_blank" class="btn btn-secondary btn-small" download>â¬‡ï¸</a>` : ''}
                        <button class="btn-icon btn-danger" onclick="deleteNotulen('${n.id}')" title="Verwijderen">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
            
            // Set date input default
            const datumInput = document.getElementById('notulen-datum');
            if (datumInput && !datumInput.value) {
                datumInput.value = new Date().toISOString().split('T')[0];
            }
        }
        
        async function addNotulen() {
            const titel = document.getElementById('notulen-titel').value.trim();
            const datum = document.getElementById('notulen-datum').value;
            const aanwezig = document.getElementById('notulen-aanwezig').value.trim();
            let bestand_url = document.getElementById('notulen-bestand').value.trim();
            const samenvatting = document.getElementById('notulen-samenvatting').value.trim();
            const fileInput = document.getElementById('notulen-file');
            
            if (!titel || !datum) {
                alert('Vul minimaal een titel en datum in');
                return;
            }
            
            const btn = event?.target;
            disableBtn(btn, 'Opslaan...');
            
            try {
                // Upload file if selected
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileName = `${datum}-${titel.replace(/[^a-zA-Z0-9]/g, '_')}.${file.name.split('.').pop()}`;
                    const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                        .from('notulen-docs')
                        .upload(fileName, file, { upsert: true });
                    
                    if (uploadError) {
                        console.error('Upload error:', uploadError);
                        showToast('Fout bij uploaden: ' + uploadError.message, 'error');
                    } else {
                        const { data: urlData } = window.supabaseClient.storage
                            .from('notulen-docs')
                            .getPublicUrl(fileName);
                        bestand_url = urlData.publicUrl;
                    }
                }
                
                const { error } = await window.supabaseClient
                    .from('notulen')
                    .insert([{ titel, datum, aanwezig, bestand_url: bestand_url || null, samenvatting: samenvatting || null }]);
                
                if (error) {
                    if (error.code === '42P01' || error.message?.includes('does not exist')) {
                        alert('Notulen tabel bestaat nog niet. Voer eerst supabase-migration-002-potjes.sql uit in de Supabase SQL Editor.');
                        return;
                    }
                    throw error;
                }
                
                // Reset form
                document.getElementById('notulen-titel').value = '';
                document.getElementById('notulen-datum').value = '';
                document.getElementById('notulen-aanwezig').value = '';
                document.getElementById('notulen-bestand').value = '';
                document.getElementById('notulen-samenvatting').value = '';
                if (document.getElementById('notulen-file')) document.getElementById('notulen-file').value = '';
                
                showToast('Notulen opgeslagen âœ…', 'success');
                await loadNotulen();
            } catch (error) {
                console.error('Notulen opslaan:', error);
                showToast('Er ging iets mis bij het opslaan: ' + (error.message || 'onbekende fout'), 'error');
            } finally {
                enableBtn(btn);
            }
        }
        
        async function deleteNotulen(id) {
            if (!confirm('Weet je zeker dat je deze notulen wilt verwijderen?')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('notulen')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                showToast('Notulen verwijderd', 'info');
                await loadNotulen();
            } catch (error) {
                console.error('Notulen verwijderen:', error);
                showToast('Er ging iets mis bij het verwijderen: ' + (error.message || 'onbekende fout'), 'error');
            }
        }

        // =====================
        // FINANCIEN FUNCTIONALITY
        // =====================
        
        let financienData = [];
        
        function initFinancienJaarFilter() {
            const select = document.getElementById('financien-jaar');
            if (!select) return;
            const currentYear = new Date().getFullYear();
            select.innerHTML = '';
            for (let y = currentYear; y >= currentYear - 3; y--) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                select.appendChild(opt);
            }
        }
        
        function getFinancienYear() {
            const el = document.getElementById('financien-jaar');
            return el ? parseInt(el.value) || new Date().getFullYear() : new Date().getFullYear();
        }
        
        async function loadFinancien() {
            if (!window.supabaseClient) return;
            const jaar = getFinancienYear();
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('financien')
                    .select('*')
                    .eq('jaar', jaar)
                    .order('datum', { ascending: false });
                
                if (error) {
                    if (error.code === '42P01' || error.message?.includes('does not exist')) {
                        document.getElementById('fin-inkomsten-list').innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 8px; font-size: 0.82rem;">âš ï¸ FinanciÃ«n tabel nog niet aangemaakt</p>';
                        document.getElementById('fin-uitgaven-list').innerHTML = '';
                        return;
                    }
                    throw error;
                }
                
                financienData = data || [];
                renderFinancien();
            } catch (error) {
                console.error('Financien laden:', error);
            }
        }
        
        function renderFinancien() {
            const inkomsten = financienData.filter(f => f.type === 'inkomst');
            const uitgaven = financienData.filter(f => f.type === 'uitgave');
            
            const totaalInkomsten = inkomsten.reduce((sum, f) => sum + (parseFloat(f.bedrag) || 0), 0);
            const totaalUitgaven = uitgaven.reduce((sum, f) => sum + (parseFloat(f.bedrag) || 0), 0);
            const saldo = totaalInkomsten - totaalUitgaven;
            
            document.getElementById('fin-totaal-inkomsten').textContent = `â‚¬${totaalInkomsten.toFixed(2)}`;
            document.getElementById('fin-totaal-uitgaven').textContent = `â‚¬${totaalUitgaven.toFixed(2)}`;
            const saldoEl = document.getElementById('fin-saldo');
            saldoEl.textContent = `â‚¬${saldo.toFixed(2)}`;
            saldoEl.style.color = saldo >= 0 ? '#10b981' : '#ef4444';
            
            const renderList = (items, containerId) => {
                const el = document.getElementById(containerId);
                if (items.length === 0) {
                    el.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 8px; font-size: 0.82rem;">Geen regels</p>';
                    return;
                }
                
                // Group by categorie
                const grouped = {};
                items.forEach(f => {
                    if (!grouped[f.categorie]) grouped[f.categorie] = [];
                    grouped[f.categorie].push(f);
                });
                
                el.innerHTML = Object.entries(grouped).map(([cat, items]) => {
                    const catTotal = items.reduce((sum, f) => sum + (parseFloat(f.bedrag) || 0), 0);
                    return `
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 2px solid var(--gray-200);">
                                <strong style="font-size: 0.82rem;">${cat}</strong>
                                <strong style="font-size: 0.82rem;">â‚¬${catTotal.toFixed(2)}</strong>
                            </div>
                            ${items.map(f => `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0; padding-left: 12px; border-bottom: 1px solid var(--gray-100); font-size: 0.78rem;">
                                    <span style="color: var(--gray-400); min-width: 60px;">${f.datum ? new Date(f.datum).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit' }) : '-'}</span>
                                    <span style="background:var(--gray-100);color:var(--gray-500);padding:1px 5px;border-radius:4px;font-size:0.68rem;font-weight:600;white-space:nowrap;">${f.kostenplaats || '90'}</span>
                                    <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${f.omschrijving || '-'}</span>
                                    ${f.bijlage_url ? `<a href="${f.bijlage_url}" target="_blank" title="${f.bijlage_naam || 'Bijlage'}" style="font-size: 0.72rem;">ğŸ“</a>` : ''}
                                    <strong style="min-width: 60px; text-align: right;">â‚¬${parseFloat(f.bedrag).toFixed(2)}</strong>
                                    <button class="btn-icon btn-danger" onclick="deleteFinancien('${f.id}')" title="Verwijderen" style="font-size: 0.7rem; padding: 2px 4px;">ğŸ—‘ï¸</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).join('');
            };
            
            renderList(inkomsten, 'fin-inkomsten-list');
            renderList(uitgaven, 'fin-uitgaven-list');
            
            // KPL overzicht
            renderKplOverzicht();
            
            // Set date default
            const datumInput = document.getElementById('fin-datum');
            if (datumInput && !datumInput.value) {
                datumInput.value = new Date().toISOString().split('T')[0];
            }
        }
        
        const KPL_NAMEN = {
            '10': 'Inbreng Gerry <2025',
            '20': 'Stichting SME VHV 1e helft 2025',
            '30': 'Subsidie SPM Dijkstra 2e helft 2025',
            '31': 'Subsidie SPM Dijkstra 2026',
            '90': 'Overig'
        };
        
        function renderKplOverzicht() {
            const el = document.getElementById('fin-kpl-overzicht');
            const byKpl = {};
            financienData.forEach(f => {
                const kpl = f.kostenplaats || '90';
                if (!byKpl[kpl]) byKpl[kpl] = { inkomsten: 0, uitgaven: 0, items: [] };
                const bedrag = parseFloat(f.bedrag) || 0;
                if (f.type === 'inkomst') byKpl[kpl].inkomsten += bedrag;
                else byKpl[kpl].uitgaven += bedrag;
                byKpl[kpl].items.push(f);
            });
            
            const sortedKpls = Object.keys(KPL_NAMEN).filter(k => byKpl[k]);
            if (sortedKpls.length === 0) {
                el.innerHTML = '<p style="text-align:center;color:var(--gray-400);padding:8px;font-size:0.82rem;">Nog geen boekingen</p>';
                return;
            }
            
            el.innerHTML = sortedKpls.map(kpl => {
                const d = byKpl[kpl];
                const saldo = d.inkomsten - d.uitgaven;
                const saldoColor = saldo >= 0 ? '#10b981' : '#ef4444';
                return `
                <div style="background:#f9fafb;border-radius:8px;padding:10px 12px;margin-bottom:8px;border-left:3px solid ${saldoColor};">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <strong style="font-size:0.85rem;">${kpl} Â· ${KPL_NAMEN[kpl]}</strong>
                        <span style="font-size:0.85rem;font-weight:700;color:${saldoColor};">Restant: â‚¬${saldo.toFixed(2)}</span>
                    </div>
                    <div style="display:flex;gap:16px;font-size:0.78rem;color:var(--gray-500);">
                        <span>ğŸ’š In: â‚¬${d.inkomsten.toFixed(2)}</span>
                        <span>ğŸ”´ Uit: â‚¬${d.uitgaven.toFixed(2)}</span>
                        <span>${d.items.length} regels</span>
                    </div>
                </div>`;
            }).join('');
        }
        
        async function addFinancien() {
            const type = document.getElementById('fin-type').value;
            const categorie = document.getElementById('fin-categorie').value;
            const bedrag = document.getElementById('fin-bedrag').value;
            const datum = document.getElementById('fin-datum').value;
            const omschrijving = document.getElementById('fin-omschrijving').value.trim();
            const fileInput = document.getElementById('fin-bijlage');
            const jaar = getFinancienYear();
            
            if (!type || !categorie || !bedrag || !datum) {
                alert('Vul type, categorie, bedrag en datum in');
                return;
            }
            
            const btn = event?.target;
            disableBtn(btn, 'Opslaan...');
            
            try {
                let bijlage_url = null;
                let bijlage_naam = null;
                
                // Upload bijlage if selected
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    bijlage_naam = file.name;
                    const fileName = `${jaar}/${datum}-${categorie.replace(/[^a-zA-Z0-9]/g, '_')}-${file.name}`;
                    const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                        .from('financien-docs')
                        .upload(fileName, file, { upsert: true });
                    
                    if (uploadError) {
                        console.error('Upload error:', uploadError);
                        showToast('Fout bij uploaden bijlage: ' + uploadError.message, 'error');
                    } else {
                        const { data: urlData } = window.supabaseClient.storage
                            .from('financien-docs')
                            .getPublicUrl(fileName);
                        bijlage_url = urlData.publicUrl;
                    }
                }
                
                const kostenplaats = document.getElementById('fin-kostenplaats').value;
                const { error } = await window.supabaseClient
                    .from('financien')
                    .insert([{
                        type, categorie, bedrag: parseFloat(bedrag), datum, omschrijving: omschrijving || null,
                        jaar, bijlage_url, bijlage_naam, kostenplaats
                    }]);
                
                if (error) throw error;
                
                // Reset form
                document.getElementById('fin-bedrag').value = '';
                document.getElementById('fin-omschrijving').value = '';
                if (fileInput) fileInput.value = '';
                
                showToast('FinanciÃ«le regel opgeslagen âœ…', 'success');
                await loadFinancien();
            } catch (error) {
                console.error('Financien opslaan:', error);
                showToast('Er ging iets mis bij het opslaan: ' + (error.message || 'onbekende fout'), 'error');
            } finally {
                enableBtn(btn);
            }
        }
        
        async function deleteFinancien(id) {
            if (!confirm('Weet je zeker dat je deze regel wilt verwijderen?')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('financien')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                showToast('Regel verwijderd', 'info');
                await loadFinancien();
            } catch (error) {
                console.error('Financien verwijderen:', error);
                showToast('Er ging iets mis bij het verwijderen: ' + (error.message || 'onbekende fout'), 'error');
            }
        }
        
        // =====================
        // NIEUWS FUNCTIONALITY
        // =====================
        
        let nieuwsData = [];
        
        const MAANDEN_NL = ['januari', 'februari', 'maart', 'april', 'mei', 'juni',
                            'juli', 'augustus', 'september', 'oktober', 'november', 'december'];

        function formatDutchDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getDate()} ${MAANDEN_NL[d.getMonth()]} ${d.getFullYear()}`;
        }
        
        // === CONTACTBERICHTEN ===
        let contactberichten = [];
        let currentReplyContact = null;

        async function loadContactberichten() {
            if (!window.supabaseClient) return;
            try {
                const { data, error } = await window.supabaseClient
                    .from('contactberichten')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                contactberichten = data || [];
                renderContactberichten();
            } catch (e) {
                console.error('Contactberichten laden mislukt:', e);
                document.getElementById('contact-list').innerHTML = '<p style="text-align:center;color:var(--gray-400);padding:12px;">Kon contactberichten niet laden.</p>';
            }
        }

        function renderContactberichten() {
            const container = document.getElementById('contact-list');
            if (!contactberichten.length) {
                container.innerHTML = '<p style="text-align:center;color:var(--gray-400);padding:24px;">Geen contactberichten.</p>';
                return;
            }
            container.innerHTML = contactberichten.map(c => {
                const datum = new Date(c.created_at).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const beantwoord = c.beantwoord === true;
                const statusBadge = beantwoord
                    ? '<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600;background:#d1fae5;color:#065f46;">âœ… Beantwoord</span>'
                    : '<span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600;background:#fef3c7;color:#92400e;">ğŸ†• Nieuw</span>';
                return `
                <div style="background:#fff;border:1.5px solid ${beantwoord ? '#d1fae5' : '#fef3c7'};border-radius:10px;padding:16px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:6px;margin-bottom:8px;">
                        <div>
                            <strong style="font-size:0.92rem;">${c.onderwerp || 'Geen onderwerp'}</strong>
                            <div style="font-size:0.78rem;color:var(--gray-500);margin-top:2px;">
                                ğŸ‘¤ ${c.naam} Â· ğŸ“§ ${c.email} Â· ğŸ“… ${datum}
                            </div>
                        </div>
                        ${statusBadge}
                    </div>
                    <p style="font-size:0.85rem;color:var(--gray-700);white-space:pre-wrap;margin:8px 0;line-height:1.5;">${c.bericht || ''}</p>
                    ${c.antwoord ? `<div style="background:var(--gray-100);border-radius:6px;padding:10px;margin-top:8px;font-size:0.82rem;"><strong>ğŸ’¬ Antwoord:</strong><p style="margin:4px 0 0;white-space:pre-wrap;">${c.antwoord}</p></div>` : ''}
                    ${!beantwoord ? `<button onclick="openContactReplyModal(${c.id})" class="btn btn-gold btn-small" style="margin-top:8px;">ğŸ’¬ Reageer</button>` : ''}
                </div>`;
            }).join('');
        }

        function openContactReplyModal(id) {
            currentReplyContact = contactberichten.find(c => c.id === id);
            if (!currentReplyContact) return;
            document.getElementById('contact-reply-info').textContent = `Aan: ${currentReplyContact.naam} (${currentReplyContact.email}) Â· ${currentReplyContact.onderwerp}`;
            document.getElementById('contact-reply-original').textContent = currentReplyContact.bericht;
            document.getElementById('contact-reply-text').value = '';
            document.getElementById('contact-reply-modal').style.display = 'block';
        }

        function closeContactReplyModal() {
            document.getElementById('contact-reply-modal').style.display = 'none';
            currentReplyContact = null;
        }

        async function sendContactReply() {
            if (!currentReplyContact) return;
            const antwoord = document.getElementById('contact-reply-text').value.trim();
            if (!antwoord) { alert('Vul een antwoord in.'); return; }

            const btn = document.getElementById('contact-reply-send-btn');
            btn.disabled = true;
            btn.textContent = 'â³ Versturen...';

            try {
                // Send email via notify function
                const resp = await fetch('/.netlify/functions/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'contact_reply',
                        data: {
                            naam: currentReplyContact.naam,
                            email: currentReplyContact.email,
                            onderwerp: currentReplyContact.onderwerp,
                            bericht: currentReplyContact.bericht,
                            antwoord: antwoord
                        }
                    })
                });
                if (!resp.ok) throw new Error('Email versturen mislukt');

                // Update in Supabase
                const { error } = await window.supabaseClient
                    .from('contactberichten')
                    .update({ beantwoord: true, antwoord: antwoord })
                    .eq('id', currentReplyContact.id);
                if (error) console.warn('Supabase update warning:', error);

                // Update local state
                const idx = contactberichten.findIndex(c => c.id === currentReplyContact.id);
                if (idx >= 0) {
                    contactberichten[idx].beantwoord = true;
                    contactberichten[idx].antwoord = antwoord;
                }
                renderContactberichten();
                closeContactReplyModal();
                alert('âœ… Antwoord verstuurd!');
            } catch (e) {
                console.error('Reageer fout:', e);
                alert('âŒ Fout bij versturen: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“§ Verstuur antwoord';
            }
        }

        async function loadNieuws() {
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('nieuws')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    if (error.code === '42P01' || error.message?.includes('does not exist') || error.message?.includes('relation')) {
                        const listEl = document.getElementById('nieuws-list');
                        if (listEl) listEl.innerHTML = '<div style="padding: 24px; text-align: center; background: #fef3c7; border-radius: var(--radius-md);"><p style="font-size: 0.9rem; color: #92400e; margin-bottom: 8px;">âš ï¸ Nieuws tabel nog niet aangemaakt</p><p style="font-size: 0.78rem; color: #78350f;">Voer de SQL migration uit: <code>supabase-migration-004-nieuws.sql</code></p></div>';
                        return;
                    }
                    throw error;
                }
                
                nieuwsData = data || [];
                renderNieuws();
            } catch (error) {
                console.error('Nieuws laden:', error);
                nieuwsData = [];
                renderNieuws();
            }
        }
        
        function renderNieuws() {
            const listEl = document.getElementById('nieuws-list');
            if (!listEl) return;
            
            if (nieuwsData.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 16px; font-size: 0.82rem;">Nog geen nieuwsberichten. Voeg er een toe via het formulier hierboven.</p>';
                return;
            }
            
            listEl.innerHTML = nieuwsData.map(n => {
                const statusColor = n.gepubliceerd ? '#10b981' : '#f59e0b';
                const statusText = n.gepubliceerd ? 'âœ… Gepubliceerd' : 'ğŸ“ Concept';
                const imageThumb = n.afbeelding_url 
                    ? `<img src="${n.afbeelding_url}" alt="" style="width: 48px; height: 48px; object-fit: cover; border-radius: 6px; flex-shrink: 0;">`
                    : `<div style="width: 48px; height: 48px; background: var(--gray-100); border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1.2rem;">ğŸ“°</div>`;
                
                return `
                    <div class="info-section" style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px; padding: 12px;">
                        ${imageThumb}
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                <strong style="font-size: 0.85rem;">${n.titel}</strong>
                                <span style="font-size: 0.7rem; padding: 1px 6px; border-radius: 8px; background: ${n.gepubliceerd ? '#d1fae5' : '#fef3c7'}; color: ${n.gepubliceerd ? '#065f46' : '#92400e'}; font-weight: 600;">${statusText}</span>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 2px;">
                                ${formatDutchDate(n.created_at)} Â· ${n.auteur || 'Kerngroep'}
                            </div>
                            ${n.samenvatting ? `<div style="font-size: 0.78rem; color: var(--gray-600); margin-top: 4px; font-style: italic;">${truncate(n.samenvatting, 120)}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 4px; flex-shrink: 0; flex-wrap: wrap;">
                            <button class="btn-icon" onclick="togglePublishNieuws(${n.id}, ${!n.gepubliceerd})" title="${n.gepubliceerd ? 'Verbergen' : 'Publiceren'}" style="font-size: 0.8rem;">
                                ${n.gepubliceerd ? 'ğŸ”’' : 'ğŸŒ'}
                            </button>
                            <button class="btn-icon" onclick="editNieuws(${n.id})" title="Bewerken" style="font-size: 0.8rem;">âœï¸</button>
                            <button class="btn-icon btn-danger" onclick="deleteNieuws(${n.id})" title="Verwijderen" style="font-size: 0.8rem;">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function previewNieuwsImage() {
            const url = document.getElementById('nieuws-afbeelding').value.trim();
            const previewEl = document.getElementById('nieuws-image-preview');
            const imgEl = document.getElementById('nieuws-image-preview-img');
            
            if (url) {
                imgEl.src = url;
                imgEl.onerror = () => { previewEl.style.display = 'none'; };
                imgEl.onload = () => { previewEl.style.display = 'block'; };
            } else {
                previewEl.style.display = 'none';
            }
        }
        
        function insertFormat(before, after, mode) {
            const ta = document.getElementById('nieuws-inhoud');
            const start = ta.selectionStart;
            const end = ta.selectionEnd;
            const selected = ta.value.substring(start, end);
            const text = mode === 'block' 
                ? before + (selected || 'tekst hier') + after + '\n'
                : before + (selected || 'tekst') + after;
            ta.value = ta.value.substring(0, start) + text + ta.value.substring(end);
            ta.focus();
            ta.selectionStart = start + before.length;
            ta.selectionEnd = start + text.length - after.length - (mode === 'block' ? 1 : 0);
        }

        async function saveNieuws() {
            const editId = document.getElementById('nieuws-edit-id').value;
            const titel = document.getElementById('nieuws-titel').value.trim();
            const samenvatting = document.getElementById('nieuws-samenvatting').value.trim();
            const inhoud = document.getElementById('nieuws-inhoud').value.trim();
            const afbeelding_url = document.getElementById('nieuws-afbeelding').value.trim();
            const auteur = document.getElementById('nieuws-auteur').value.trim() || 'Kerngroep';
            const gepubliceerd = document.getElementById('nieuws-gepubliceerd').checked;
            
            if (!titel || !inhoud) {
                alert('Vul minimaal een titel en inhoud in');
                return;
            }
            
            const btn = event?.target;
            disableBtn(btn, 'Opslaan...');
            
            try {
                if (editId) {
                    // Update existing
                    const { error } = await window.supabaseClient
                        .from('nieuws')
                        .update({
                            titel,
                            samenvatting: samenvatting || null,
                            inhoud,
                            afbeelding_url: afbeelding_url || null,
                            auteur,
                            gepubliceerd,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', parseInt(editId));
                    
                    if (error) throw error;
                } else {
                    // Insert new
                    const { error } = await window.supabaseClient
                        .from('nieuws')
                        .insert([{
                            titel,
                            samenvatting: samenvatting || null,
                            inhoud,
                            afbeelding_url: afbeelding_url || null,
                            auteur,
                            gepubliceerd
                        }]);
                    
                    if (error) {
                        if (error.code === '42P01' || error.message?.includes('does not exist')) {
                            alert('Nieuws tabel bestaat nog niet. Voer eerst supabase-migration-004-nieuws.sql uit in de Supabase SQL Editor.');
                            return;
                        }
                        throw error;
                    }
                }
                
                resetNieuwsForm();
                showToast(editId ? 'Artikel bijgewerkt âœ…' : 'Artikel opgeslagen âœ…', 'success');
                await loadNieuws();
            } catch (error) {
                console.error('Nieuws opslaan:', error);
                showToast('Er ging iets mis bij het opslaan: ' + (error.message || 'onbekende fout'), 'error');
            } finally {
                enableBtn(btn);
            }
        }
        
        function editNieuws(id) {
            const article = nieuwsData.find(n => n.id === id);
            if (!article) return;
            
            document.getElementById('nieuws-edit-id').value = article.id;
            document.getElementById('nieuws-titel').value = article.titel || '';
            document.getElementById('nieuws-samenvatting').value = article.samenvatting || '';
            document.getElementById('nieuws-inhoud').value = article.inhoud || '';
            document.getElementById('nieuws-afbeelding').value = article.afbeelding_url || '';
            document.getElementById('nieuws-auteur').value = article.auteur || 'Kerngroep';
            document.getElementById('nieuws-gepubliceerd').checked = article.gepubliceerd;
            
            document.getElementById('nieuws-form-title').textContent = 'âœï¸ Artikel bewerken';
            document.getElementById('nieuws-cancel-btn').style.display = 'inline-block';
            
            previewNieuwsImage();
            
            // Scroll to form
            document.getElementById('nieuws-form-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function resetNieuwsForm() {
            document.getElementById('nieuws-edit-id').value = '';
            document.getElementById('nieuws-titel').value = '';
            document.getElementById('nieuws-samenvatting').value = '';
            document.getElementById('nieuws-inhoud').value = '';
            document.getElementById('nieuws-afbeelding').value = '';
            document.getElementById('nieuws-auteur').value = 'Kerngroep';
            document.getElementById('nieuws-gepubliceerd').checked = false;
            document.getElementById('nieuws-image-preview').style.display = 'none';
            document.getElementById('nieuws-form-title').textContent = 'â• Nieuw artikel';
            document.getElementById('nieuws-cancel-btn').style.display = 'none';
        }
        
        async function togglePublishNieuws(id, publish) {
            try {
                const { error } = await window.supabaseClient
                    .from('nieuws')
                    .update({ 
                        gepubliceerd: publish,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) throw error;
                await loadNieuws();
            } catch (error) {
                console.error('Publicatie status wijzigen:', error);
            }
        }
        
        async function deleteNieuws(id) {
            if (!confirm('Weet je zeker dat je dit nieuwsbericht wilt verwijderen?')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('nieuws')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                showToast('Nieuwsbericht verwijderd', 'info');
                await loadNieuws();
            } catch (error) {
                console.error('Nieuws verwijderen:', error);
                showToast('Er ging iets mis bij het verwijderen: ' + (error.message || 'onbekende fout'), 'error');
            }
        }
        // Nieuwsbrief
        function updateNieuwsbriefCount() {
            const count = (ambassadeursData || []).filter(a => a.email && a.email.trim()).length;
            const el = document.getElementById('nieuwsbrief-count');
            if (el) el.textContent = `Wordt verstuurd naar ${count} ambassadeur${count !== 1 ? 's' : ''} met emailadres`;
        }

        async function verstuurNieuwsbrief() {
            const onderwerp = document.getElementById('nieuwsbrief-onderwerp').value.trim();
            const bericht = document.getElementById('nieuwsbrief-bericht').value.trim();
            if (!onderwerp || !bericht) {
                showToast('Vul onderwerp en bericht in', 'error');
                return;
            }
            const count = (ambassadeursData || []).filter(a => a.email && a.email.trim()).length;
            if (count === 0) {
                showToast('Geen ambassadeurs met emailadres gevonden', 'error');
                return;
            }
            if (!confirm(`Weet je zeker dat je deze nieuwsbrief wilt versturen naar ${count} ambassadeur${count !== 1 ? 's' : ''}?`)) return;

            const btn = document.getElementById('nieuwsbrief-send-btn');
            btn.disabled = true;
            btn.textContent = 'â³ Versturen...';

            try {
                const response = await fetch('/.netlify/functions/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'nieuwsbrief', data: { onderwerp, bericht } })
                });
                const result = await response.json();
                if (result.success) {
                    showToast(`âœ… Nieuwsbrief verstuurd naar ${result.sent || count} ambassadeur${(result.sent || count) !== 1 ? 's' : ''}!`, 'success');
                    document.getElementById('nieuwsbrief-onderwerp').value = '';
                    document.getElementById('nieuwsbrief-bericht').value = '';
                } else {
                    showToast('Fout: ' + (result.error || 'onbekend'), 'error');
                }
            } catch (error) {
                showToast('Versturen mislukt: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“§ Verstuur nieuwsbrief';
            }
        }

        // =====================
        // CONTACTBERICHTEN
        // =====================
        let contactberichtenData = [];

        async function loadContactberichten() {
            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('contactberichten')
                        .select('*')
                        .order('created_at', { ascending: false });
                    if (error) throw error;
                    contactberichtenData = data || [];
                }
                renderContactberichten();
            } catch (e) {
                console.error('Contactberichten laden:', e);
                document.getElementById('contact-list').innerHTML = '<p style="color:var(--gray-400);">Kon berichten niet laden.</p>';
            }
        }

        function renderContactberichten() {
            const container = document.getElementById('contact-list');
            if (!contactberichtenData.length) {
                container.innerHTML = '<p style="color:var(--gray-400);text-align:center;padding:20px;">Geen contactberichten.</p>';
                return;
            }
            container.innerHTML = contactberichtenData.map(c => {
                const datum = new Date(c.created_at).toLocaleDateString('nl-NL', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                const beantwoord = c.beantwoord;
                const statusBadge = beantwoord
                    ? '<span style="background:#d1fae5;color:#065f46;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600;">âœ… Beantwoord</span>'
                    : '<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600;">ğŸ†• Nieuw</span>';
                return `
                <div style="background:#fff;border:1.5px solid var(--gray-100);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px;${!beantwoord ? 'border-left:3px solid var(--accent-gold);' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:4px;">
                        <strong style="font-size:0.85rem;">${c.onderwerp || 'Geen onderwerp'}</strong>
                        ${statusBadge}
                    </div>
                    <div style="font-size:0.78rem;color:var(--gray-500);margin-bottom:8px;">
                        <strong>${c.naam}</strong> Â· <a href="mailto:${c.email}" style="color:var(--street-blue);">${c.email}</a> Â· ${datum}
                    </div>
                    <div style="font-size:0.82rem;line-height:1.6;color:var(--gray-700);background:#f9fafb;padding:10px;border-radius:6px;margin-bottom:8px;white-space:pre-wrap;">${c.bericht}</div>
                    ${c.antwoord ? `<div style="font-size:0.8rem;line-height:1.5;color:#065f46;background:#ecfdf5;padding:10px;border-radius:6px;margin-bottom:8px;"><strong>Ons antwoord:</strong><br>${c.antwoord}</div>` : ''}
                    <div style="display:flex;gap:6px;flex-wrap:wrap;">
                        ${!beantwoord ? `<button onclick="showReplyModal('${c.id}','${c.naam.replace(/'/g,"\\'")}','${c.email}','${(c.onderwerp||'').replace(/'/g,"\\'")}','${(c.bericht||'').replace(/'/g,"\\'").replace(/\n/g,"\\n")}')" class="btn btn-gold btn-small">âœ‰ï¸ Beantwoorden</button>` : ''}
                        <button onclick="deleteContactbericht('${c.id}')" class="btn btn-small" style="background:var(--gray-200);color:var(--gray-600);">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            }).join('');
        }

        function showReplyModal(id, naam, email, onderwerp, bericht) {
            window._replyBericht = bericht || '';
            openModal('âœ‰ï¸ Beantwoorden', `
                <p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:8px;">Antwoord aan <strong>${naam}</strong> (${email})</p>
                <p style="font-size:0.78rem;color:var(--gray-400);margin-bottom:12px;">Onderwerp: Re: ${onderwerp}</p>
                <textarea id="reply-text" rows="8" placeholder="Typ hier je antwoord..." style="width:100%;padding:10px;border:1.5px solid var(--gray-200);border-radius:var(--radius-sm);font-size:0.85rem;resize:vertical;line-height:1.5;font-family:inherit;"></textarea>
                <div id="reply-result" style="display:none;margin-top:8px;"></div>
            `, `
                <button class="btn btn-secondary" onclick="closeAllModals()">Annuleren</button>
                <button class="btn btn-gold" id="btn-send-reply" onclick="sendReply('${id}','${naam.replace(/'/g,"\\'")}','${email}','${onderwerp.replace(/'/g,"\\'")}')">ğŸ“§ Verstuur antwoord</button>
            `, { maxWidth: '500px' });
        }

        async function sendReply(id, naam, email, onderwerp) {
            const antwoord = document.getElementById('reply-text').value.trim();
            if (!antwoord) { showToast('Typ een antwoord', 'error'); return; }

            const btn = document.getElementById('btn-send-reply');
            disableBtn(btn, 'â³ Versturen...');

            try {
                const resp = await fetch('/.netlify/functions/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'contact_reply',
                        data: { naam, email, onderwerp, bericht: window._replyBericht || '', antwoord, beantwoord_door: getAdminNaam() }
                    })
                });
                const result = await resp.json();
                if (!result.success && result.error) throw new Error(result.error);

                // Update in Supabase
                if (window.supabaseClient) {
                    await window.supabaseClient.from('contactberichten').update({
                        beantwoord: true,
                        antwoord: antwoord,
                        beantwoord_door: getAdminNaam(),
                        beantwoord_op: new Date().toISOString()
                    }).eq('id', id);
                }

                closeAllModals();
                showToast('âœ… Antwoord verstuurd naar ' + email, 'success');
                await loadContactberichten();
            } catch (e) {
                showToast('Fout: ' + e.message, 'error');
            } finally {
                enableBtn(btn);
            }
        }

        async function deleteContactbericht(id) {
            if (!confirm('Weet je zeker dat je dit bericht wilt verwijderen?')) return;
            try {
                if (window.supabaseClient) {
                    await window.supabaseClient.from('contactberichten').delete().eq('id', id);
                }
                showToast('Bericht verwijderd', 'success');
                await loadContactberichten();
            } catch (e) {
                showToast('Fout: ' + e.message, 'error');
            }
        }

    </script>
</body>
</html>
