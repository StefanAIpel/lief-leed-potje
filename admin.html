<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beheer - Straatambassadeurs</title>
    <link rel="stylesheet" href="styles.css?v=20260208a">
    <meta name="theme-color" content="#1a2744">
    <link rel="icon" href="favicon.png">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-card" style="max-width: 380px;">
            <img src="images/logo-header-new.png" alt="Straatambassadeurs" style="width: 200px; height: auto; margin-bottom: 20px;">
            <h1 style="font-size: 1.2rem; margin-bottom: 4px;">üîê Beheer Kerngroep</h1>
            <p style="color: var(--gray-500); margin-bottom: 20px; font-size: 0.85rem;">Alleen toegankelijk voor leden van de kerngroep.<br>Voer je PIN code in om in te loggen.</p>
            
            <div id="login-error" class="login-error hidden">Onjuiste PIN code</div>
            
            <div id="login-form">
                <div class="form-group">
                    <input type="password" id="pin" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" autofocus 
                           onkeydown="if(event.key==='Enter')doLogin()">
                </div>
                <button type="button" class="btn btn-primary btn-full" onclick="doLogin()">Inloggen</button>
            </div>
            
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                <a href="index.html" style="color: var(--street-blue); text-decoration: none; font-size: 0.9rem; font-weight: 600;">‚Üê Terug naar de website</a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden">
        <div class="container">
            <div style="background: var(--night-blue); padding: 12px 20px; border-radius: var(--radius-lg); margin-bottom: var(--space-md); display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img src="images/logo-square.png" alt="" style="width: 36px; height: 36px; border-radius: 6px;">
                    <div>
                        <div style="color: var(--accent-gold); font-weight: 700; font-size: 1rem;">üîê Beheer Kerngroep</div>
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">Admin Dashboard</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <a href="index.html" style="color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.82rem; padding: 6px 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px;">‚Üê Terug naar site</a>
                    <button onclick="logout()" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 0.82rem; cursor: pointer;">Uitloggen</button>
                </div>
            </div>

            <main>
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card stat-nieuw">
                        <div class="stat-number" id="stat-nieuw">0</div>
                        <div class="stat-label">Nieuw</div>
                    </div>
                    <div class="stat-card stat-behandeling">
                        <div class="stat-number" id="stat-behandeling">0</div>
                        <div class="stat-label">In behandeling</div>
                    </div>
                    <div class="stat-card stat-uitgekeerd">
                        <div class="stat-number" id="stat-uitgekeerd">0</div>
                        <div class="stat-label">Uitgekeerd</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="stat-ambassadeurs">0</div>
                        <div class="stat-label">Ambassadeurs</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="showTab('aanvragen')">üìã Aanvragen</button>
                    <button class="tab-btn" onclick="showTab('ambassadeurs')">üë• Ambassadeurs</button>
                    <button class="tab-btn" onclick="showTab('aanmeldingen')">üôã Aanmeldingen</button>
                    <button class="tab-btn" onclick="showTab('potjes')">üí∞ Potjes</button>
                    <button class="tab-btn" onclick="showTab('notulen')">üìù Notulen</button>
                </div>

                <!-- Tab: Aanvragen -->
                <div id="tab-aanvragen" class="tab-content active">
                    <div class="filter-section">
                        <select id="filter-status" onchange="filterAanvragen()">
                            <option value="">Alle statussen</option>
                            <option value="nieuw">Nieuw</option>
                            <option value="in_behandeling">In behandeling</option>
                            <option value="uitgekeerd">Uitgekeerd</option>
                            <option value="afgewezen">Afgewezen</option>
                        </select>
                        <input type="text" id="filter-search" placeholder="Zoeken..." oninput="filterAanvragen()">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Ambassadeur</th>
                                    <th>Straat</th>
                                    <th>Doel</th>
                                    <th>Status</th>
                                    <th>Acties</th>
                                </tr>
                            </thead>
                            <tbody id="aanvragen-tbody">
                                <tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Laden...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Ambassadeurs -->
                <div id="tab-ambassadeurs" class="tab-content">
                    <div class="add-form">
                        <div class="form-group" style="margin: 0;">
                            <label>Naam</label>
                            <input type="text" id="new-amb-naam" placeholder="Volledige naam">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label>Straat</label>
                            <input type="text" id="new-amb-straat" placeholder="Straatnaam">
                        </div>
                        <button onclick="addAmbassadeur()" class="btn btn-gold">+ Toevoegen</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Naam</th>
                                    <th>Straat</th>
                                    <th>Telefoon</th>
                                    <th>Actief</th>
                                    <th>Acties</th>
                                </tr>
                            </thead>
                            <tbody id="ambassadeurs-tbody">
                                <tr><td colspan="5" style="text-align: center; padding: 24px; color: var(--gray-400);">Laden...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Aanmeldingen -->
                <div id="tab-aanmeldingen" class="tab-content">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Naam</th>
                                    <th>Straat</th>
                                    <th>Telefoon</th>
                                    <th>Status</th>
                                    <th>Acties</th>
                                </tr>
                            </thead>
                            <tbody id="aanmeldingen-tbody">
                                <tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Laden...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Potjes -->
                <div id="tab-potjes" class="tab-content">
                    <div id="potjes-error" class="hidden" style="padding: 24px; text-align: center; background: #fef3c7; border-radius: var(--radius-md); margin-bottom: 16px;">
                        <p style="font-size: 0.9rem; color: #92400e; margin-bottom: 8px;">‚ö†Ô∏è Potjes tabellen nog niet aangemaakt</p>
                        <p style="font-size: 0.78rem; color: #78350f;">Voer de SQL migration uit: <code>supabase-migration-002-potjes.sql</code></p>
                    </div>
                    <div id="potjes-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                            <h3 style="margin: 0; font-size: 1rem; color: var(--night-blue);">üí∞ Potjes Overzicht</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="potjes-jaar" onchange="loadPotjes()" style="padding: 6px 10px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem;">
                                </select>
                            </div>
                        </div>

                        <!-- Summary stats -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
                            <div class="stat-card" style="border-color: var(--status-goedgekeurd);">
                                <div class="stat-number" id="potjes-totaal-budget" style="color: var(--status-goedgekeurd); font-size: 1.2rem;">‚Ç¨0</div>
                                <div class="stat-label">Totaal budget</div>
                            </div>
                            <div class="stat-card" style="border-color: var(--status-behandeling);">
                                <div class="stat-number" id="potjes-totaal-besteed" style="color: var(--status-behandeling); font-size: 1.2rem;">‚Ç¨0</div>
                                <div class="stat-label">Besteed</div>
                            </div>
                            <div class="stat-card" style="border-color: var(--status-nieuw);">
                                <div class="stat-number" id="potjes-totaal-resterend" style="color: var(--status-nieuw); font-size: 1.2rem;">‚Ç¨0</div>
                                <div class="stat-label">Resterend</div>
                            </div>
                        </div>

                        <!-- Per ambassadeur overview -->
                        <div class="info-section" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 8px;">Per ambassadeur</h3>
                            <div id="potjes-per-ambassadeur">
                                <p style="text-align: center; color: var(--gray-400); padding: 12px;">Laden...</p>
                            </div>
                        </div>

                        <!-- Add expense form -->
                        <div class="info-section" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 12px;">‚ûï Uitgave toevoegen</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 0.78rem;">Ambassadeur</label>
                                    <select id="potje-ambassadeur" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                        <option value="">Kies ambassadeur...</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 0.78rem;">Bedrag (‚Ç¨)</label>
                                    <input type="number" id="potje-bedrag" step="0.01" min="0" placeholder="0.00" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 0.78rem;">Omschrijving</label>
                                    <input type="text" id="potje-omschrijving" placeholder="Waarvoor..." style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label style="font-size: 0.78rem;">Datum</label>
                                    <input type="date" id="potje-datum" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                                </div>
                            </div>
                            <button onclick="addUitgave()" class="btn btn-gold btn-small" style="margin-top: 8px;">üí∞ Uitgave opslaan</button>
                        </div>

                        <!-- All expenses table -->
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Datum</th>
                                        <th>Ambassadeur</th>
                                        <th>Omschrijving</th>
                                        <th>Bedrag</th>
                                        <th>Acties</th>
                                    </tr>
                                </thead>
                                <tbody id="potjes-uitgaven-tbody">
                                    <tr><td colspan="5" style="text-align: center; padding: 24px; color: var(--gray-400);">Laden...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab: Notulen -->
                <div id="tab-notulen" class="tab-content">
                    <div class="info-section" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 8px;">üìù Notulen Kerngroep Vergaderingen</h3>
                        <p style="font-size: 0.85rem; color: var(--gray-500);">Verslagen van de kerngroep bijeenkomsten. Alleen zichtbaar voor ingelogde beheerders.</p>
                    </div>

                    <!-- Upload form -->
                    <div class="info-section" style="margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px;">‚ûï Notulen toevoegen</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Titel</label>
                                <input type="text" id="notulen-titel" placeholder="Bijv. Kerngroep overleg" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label style="font-size: 0.78rem;">Datum</label>
                                <input type="date" id="notulen-datum" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Aanwezigen</label>
                                <input type="text" id="notulen-aanwezig" placeholder="Frank, Carien, Stefan, ..." style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Bestand URL (optioneel, bijv. docs/notulen.pdf)</label>
                                <input type="text" id="notulen-bestand" placeholder="docs/bestandsnaam.pdf" style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%;">
                            </div>
                            <div class="form-group" style="margin: 0; grid-column: 1 / -1;">
                                <label style="font-size: 0.78rem;">Samenvatting (optioneel)</label>
                                <textarea id="notulen-samenvatting" rows="2" placeholder="Korte samenvatting van de vergadering..." style="padding: 8px; border: 1.5px solid var(--gray-200); border-radius: var(--radius-sm); font-size: 0.82rem; width: 100%; resize: vertical;"></textarea>
                            </div>
                        </div>
                        <button onclick="addNotulen()" class="btn btn-gold btn-small" style="margin-top: 8px;">üìù Notulen opslaan</button>
                    </div>

                    <!-- Notulen list (dynamic from Supabase + static fallback) -->
                    <div id="notulen-list">
                        <p style="text-align: center; color: var(--gray-400); padding: 12px;">Laden...</p>
                    </div>

                    <!-- Static fallback: existing PDF in docs/ folder -->
                    <div id="notulen-static" class="info-section" style="margin-top: 12px; background: var(--gray-100);">
                        <h3 style="font-size: 0.85rem; margin-bottom: 8px;">üìÅ Bestanden in docs/ map</h3>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <strong style="font-size: 0.82rem;">üìÑ notulen-kerngroep.pdf</strong><br>
                                <span style="font-size: 0.75rem; color: var(--gray-500);">Origineel bestand</span>
                            </div>
                            <a href="docs/notulen-kerngroep.pdf" target="_blank" class="btn btn-secondary btn-small" download>‚¨áÔ∏è Download</a>
                        </div>
                    </div>
                </div>
            </main>

            <footer>
                <div class="footer-houses"></div>
                <div class="footer-title">Straatambassadeurs Beheer</div>
            </footer>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Aanvraag Details</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="supabase-config.js"></script>
    <script>
        // PIN wordt server-side geverifieerd via Netlify Function
        let aanvragenData = [];
        let ambassadeursData = [];
        let aanmeldingenData = [];
        let potjeUitgavenData = [];
        let potjeToekenningenData = [];
        let notulenData = [];
        let potjesTablesExist = true;
        
        // Login functie
        async function doLogin() {
            const pin = document.getElementById('pin').value;
            const errorEl = document.getElementById('login-error');
            const submitBtn = document.querySelector('#login-form button');
            
            if (!pin) return;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Controleren...';
            errorEl.classList.add('hidden');
            
            try {
                const response = await fetch('/.netlify/functions/verify-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    sessionStorage.setItem('admin_logged_in', 'true');
                    sessionStorage.setItem('admin_pin', pin);
                    showDashboard();
                } else {
                    errorEl.classList.remove('hidden');
                    document.getElementById('pin').value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'Verbindingsfout. Probeer opnieuw.';
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Inloggen';
            }
        }
        
        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadAllData();
        }
        
        function logout() {
            sessionStorage.removeItem('admin_logged_in');
            location.reload();
        }
        
        // Check session
        document.addEventListener('DOMContentLoaded', () => {
            // supabase-config.js already creates window.supabaseClient via CDN
            // If not ready yet, try manually
            if (!window.supabaseClient && window.supabase && window.supabase.createClient) {
                window.supabaseClient = window.supabase.createClient('https://knxdefuncbzzbrunhlxg.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtueGRlZnVuY2J6emJydW5obHhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMjM0NzIsImV4cCI6MjA4NTU5OTQ3Mn0.QRQ0uxK65s_9EaVZkqpFMGOGCvpH5GKisHqg1ZZay3Y');
            }
            if (window.supabaseClient) {
                console.log('‚úÖ Supabase admin client ready');
            } else {
                console.error('‚ùå Supabase client not available');
            }
            if (sessionStorage.getItem('admin_logged_in') === 'true') {
                showDashboard();
            }
        });
        
        // Tabs
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadAanvragen(),
                loadAmbassadeurs(),
                loadAanmeldingen(),
                loadPotjes(),
                loadNotulen()
            ]);
            updateStats();
            initPotjesJaarFilter();
            populateAmbassadeurDropdown();
        }
        
        // Load Aanvragen
        async function loadAanvragen() {
            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('aanvragen')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    aanvragenData = data || [];
                }
                renderAanvragen();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderAanvragen() {
            const tbody = document.getElementById('aanvragen-tbody');
            const filterStatus = document.getElementById('filter-status').value;
            const filterSearch = document.getElementById('filter-search').value.toLowerCase();
            
            let filtered = aanvragenData;
            if (filterStatus) {
                filtered = filtered.filter(a => a.status === filterStatus);
            }
            if (filterSearch) {
                filtered = filtered.filter(a => 
                    a.ambassadeur_naam?.toLowerCase().includes(filterSearch) ||
                    a.straat?.toLowerCase().includes(filterSearch) ||
                    a.doel?.toLowerCase().includes(filterSearch)
                );
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Geen aanvragen gevonden</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(a => `
                <tr>
                    <td data-label="Datum">${formatDate(a.created_at)}</td>
                    <td data-label="Ambassadeur"><strong>${a.ambassadeur_naam || '-'}</strong></td>
                    <td data-label="Straat">${a.straat || '-'}</td>
                    <td data-label="Doel" style="max-width: 200px;">${truncate(a.doel, 50)}</td>
                    <td data-label="Status"><span class="status-badge ${a.status}">${formatStatus(a.status)}</span></td>
                    <td data-label="Acties">
                        <button class="btn-icon" onclick="showDetail(${a.id})" title="Bekijken">üëÅÔ∏è</button>
                        ${a.status === 'nieuw' ? `
                            <button class="btn-icon btn-warning" onclick="updateStatus(${a.id}, 'in_behandeling')" title="In behandeling">‚è≥</button>
                        ` : ''}
                        ${a.status === 'in_behandeling' ? `
                            <button class="btn-icon btn-success" onclick="updateStatus(${a.id}, 'uitgekeerd')" title="Uitgekeerd">‚úÖ</button>
                            <button class="btn-icon btn-danger" onclick="updateStatus(${a.id}, 'afgewezen')" title="Afwijzen">‚ùå</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        function filterAanvragen() {
            renderAanvragen();
        }
        
        // Load Ambassadeurs
        async function loadAmbassadeurs() {
            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .select('*')
                        .order('naam');
                    
                    if (error) throw error;
                    ambassadeursData = data || [];
                }
                renderAmbassadeurs();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderAmbassadeurs() {
            const tbody = document.getElementById('ambassadeurs-tbody');
            
            if (ambassadeursData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px; color: var(--gray-400);">Geen ambassadeurs</td></tr>';
                return;
            }
            
            tbody.innerHTML = ambassadeursData.map(a => `
                <tr style="${!a.actief ? 'opacity: 0.5;' : ''}">
                    <td data-label="Naam"><strong>${a.naam}</strong></td>
                    <td data-label="Straat">${a.straat || '-'}</td>
                    <td data-label="Telefoon">${a.telefoon || '-'}</td>
                    <td data-label="Actief">${a.actief ? '‚úÖ' : '‚ùå'}</td>
                    <td data-label="Acties">
                        <button class="btn-icon" onclick="toggleAmbassadeur(${a.id}, ${!a.actief})" title="${a.actief ? 'Deactiveren' : 'Activeren'}">
                            ${a.actief ? 'üö´' : '‚úÖ'}
                        </button>
                        <button class="btn-icon btn-danger" onclick="deleteAmbassadeur(${a.id})" title="Verwijderen">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function addAmbassadeur() {
            const naam = document.getElementById('new-amb-naam').value.trim();
            const straat = document.getElementById('new-amb-straat').value.trim();
            
            if (!naam || !straat) {
                alert('Vul naam en straat in');
                return;
            }
            
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .insert([{ naam, straat, actief: true }]);
                    
                    if (error) throw error;
                }
                
                document.getElementById('new-amb-naam').value = '';
                document.getElementById('new-amb-straat').value = '';
                await loadAmbassadeurs();
                updateStats();
                
            } catch (error) {
                console.error('Error:', error);
                alert('Er ging iets mis');
            }
        }
        
        async function toggleAmbassadeur(id, actief) {
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .update({ actief })
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                await loadAmbassadeurs();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        async function deleteAmbassadeur(id) {
            if (!confirm('Weet je zeker dat je deze ambassadeur wilt verwijderen?')) return;
            
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('ambassadeurs')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                await loadAmbassadeurs();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Load Aanmeldingen (nieuwe ambassadeurs)
        async function loadAanmeldingen() {
            try {
                if (window.supabaseClient) {
                    const { data, error } = await window.supabaseClient
                        .from('aanmeldingen')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    aanmeldingenData = data || [];
                }
                renderAanmeldingen();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function renderAanmeldingen() {
            const tbody = document.getElementById('aanmeldingen-tbody');
            
            if (aanmeldingenData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--gray-400);">Geen aanmeldingen</td></tr>';
                return;
            }
            
            tbody.innerHTML = aanmeldingenData.map(a => `
                <tr>
                    <td data-label="Datum">${formatDate(a.created_at)}</td>
                    <td data-label="Naam"><strong>${a.naam}</strong></td>
                    <td data-label="Straat">${a.straat}</td>
                    <td data-label="Telefoon">${a.telefoon}</td>
                    <td data-label="Status"><span class="status-badge ${a.status}">${formatStatus(a.status)}</span></td>
                    <td data-label="Acties">
                        ${a.status === 'nieuw' ? `
                            <button class="btn-icon btn-success" onclick="approveAanmelding(${a.id})" title="Goedkeuren & toevoegen">‚úÖ</button>
                            <button class="btn-icon btn-danger" onclick="rejectAanmelding(${a.id})" title="Afwijzen">‚ùå</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        async function approveAanmelding(id) {
            const aanmelding = aanmeldingenData.find(a => a.id === id);
            if (!aanmelding) return;
            
            try {
                // Add as ambassadeur
                if (window.supabaseClient) {
                    await window.supabaseClient.from('ambassadeurs').insert([{
                        naam: aanmelding.naam,
                        straat: aanmelding.straat,
                        telefoon: aanmelding.telefoon,
                        email: aanmelding.email,
                        actief: true
                    }]);
                    
                    // Update aanmelding status
                    await window.supabaseClient.from('aanmeldingen')
                        .update({ status: 'goedgekeurd' })
                        .eq('id', id);
                }
                
                await loadAllData();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        async function rejectAanmelding(id) {
            try {
                if (window.supabaseClient) {
                    await window.supabaseClient.from('aanmeldingen')
                        .update({ status: 'afgewezen' })
                        .eq('id', id);
                }
                await loadAanmeldingen();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Update Status
        async function updateStatus(id, status) {
            try {
                if (window.supabaseClient) {
                    const { error } = await window.supabaseClient
                        .from('aanvragen')
                        .update({ status, updated_at: new Date().toISOString() })
                        .eq('id', id);
                    
                    if (error) throw error;
                }
                await loadAanvragen();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Show Detail Modal
        function showDetail(id) {
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            document.getElementById('modal-body').innerHTML = `
                <div class="form-section">
                    <div class="form-row">
                        <div><strong>Ambassadeur:</strong><br>${aanvraag.ambassadeur_naam}</div>
                        <div><strong>Straat:</strong><br>${aanvraag.straat}</div>
                    </div>
                    <div class="form-row" style="margin-top: 12px;">
                        <div><strong>Telefoon:</strong><br>${aanvraag.telefoon || '-'}</div>
                        <div><strong>E-mail:</strong><br>${aanvraag.email || '-'}</div>
                    </div>
                    <div style="margin-top: 12px;">
                        <strong>Status:</strong> <span class="status-badge ${aanvraag.status}">${formatStatus(aanvraag.status)}</span>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4>Doel</h4>
                    <p>${aanvraag.doel || '-'}</p>
                </div>
                
                ${aanvraag.eerder_ontvangen ? `
                <div class="form-section">
                    <h4>Eerder potje</h4>
                    <p><strong>Wanneer:</strong> ${aanvraag.eerder_maand}/${aanvraag.eerder_jaar}</p>
                    <p><strong>Waarvoor:</strong> ${aanvraag.vorig_gebruik || '-'}</p>
                </div>
                ` : ''}
                
                ${aanvraag.ervaring ? `
                <div class="form-section">
                    <h4>Gedeelde ervaring</h4>
                    <p>${aanvraag.ervaring}</p>
                </div>
                ` : ''}
                
                <div class="form-section">
                    <h4>Betaalgegevens</h4>
                    <p><strong>IBAN:</strong> ${aanvraag.iban || '-'}</p>
                    <p><strong>Tenaamstelling:</strong> ${aanvraag.tenaamstelling || '-'}</p>
                </div>
                
                <div class="form-section">
                    <h4>Administratie</h4>
                    <p>${aanvraag.administratie === 'zelf' ? 'Bewaart zelf de administratie' : 'Levert aan bij kerngroep'}</p>
                </div>
                
                <div style="font-size: 0.75rem; color: var(--gray-400); margin-top: 16px;">
                    Aangevraagd op: ${formatDateTime(aanvraag.created_at)}
                </div>
                
                <div style="margin-top: 16px; display: flex; gap: 8px;">
                    <button onclick="printAanvraag(${aanvraag.id})" class="btn btn-secondary" style="flex: 1;">üñ®Ô∏è Printen</button>
                    ${aanvraag.status === 'nieuw' ? `<button onclick="updateStatus(${aanvraag.id}, 'in_behandeling'); closeModal();" class="btn btn-gold" style="flex: 1;">‚è≥ In behandeling</button>` : ''}
                    ${aanvraag.status === 'in_behandeling' ? `
                        <button onclick="updateStatus(${aanvraag.id}, 'uitgekeerd'); closeModal();" class="btn btn-primary" style="flex: 1;">‚úÖ Uitgekeerd</button>
                        <button onclick="updateStatus(${aanvraag.id}, 'afgewezen'); closeModal();" class="btn btn-secondary" style="flex: 1; background: #fee2e2; color: #991b1b;">‚ùå Afwijzen</button>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('detail-modal').classList.remove('hidden');
        }
        
        function printAanvraag(id) {
            const aanvraag = aanvragenData.find(a => a.id === id);
            if (!aanvraag) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="nl">
                <head>
                    <meta charset="UTF-8">
                    <title>Aanvraag - ${aanvraag.ambassadeur_naam}</title>
                    <style>
                        body { font-family: Arial, sans-serif; max-width: 700px; margin: 40px auto; padding: 20px; color: #333; }
                        h1 { color: #1a2744; font-size: 1.4rem; border-bottom: 3px solid #f4c542; padding-bottom: 10px; }
                        .logo { text-align: center; margin-bottom: 20px; }
                        .logo img { height: 60px; }
                        .section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2855a3; }
                        .section h3 { color: #1a2744; font-size: 0.95rem; margin: 0 0 10px 0; text-transform: uppercase; }
                        .row { display: flex; gap: 20px; margin-bottom: 8px; }
                        .row > div { flex: 1; }
                        .label { font-size: 0.8rem; color: #6b7280; text-transform: uppercase; }
                        .value { font-weight: 600; font-size: 0.95rem; }
                        .status { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700; }
                        .status.nieuw { background: #e0e7ff; color: #3730a3; }
                        .status.in_behandeling { background: #fef3c7; color: #92400e; }
                        .status.uitgekeerd { background: #d1fae5; color: #065f46; }
                        .status.afgewezen { background: #fee2e2; color: #991b1b; }
                        .footer { margin-top: 30px; text-align: center; color: #9ca3af; font-size: 0.8rem; border-top: 1px solid #e5e7eb; padding-top: 15px; }
                        .signature { margin-top: 40px; display: flex; gap: 40px; }
                        .signature > div { flex: 1; border-top: 1px solid #333; padding-top: 8px; font-size: 0.85rem; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <h1>üß° Lief & Leed Potje ‚Äî Aanvraag</h1>
                    
                    <div class="section">
                        <h3>Aanvrager</h3>
                        <div class="row">
                            <div><span class="label">Naam</span><br><span class="value">${aanvraag.ambassadeur_naam}</span></div>
                            <div><span class="label">Straat</span><br><span class="value">${aanvraag.straat}</span></div>
                        </div>
                        <div class="row">
                            <div><span class="label">Telefoon</span><br><span class="value">${aanvraag.telefoon || '-'}</span></div>
                            <div><span class="label">E-mail</span><br><span class="value">${aanvraag.email || '-'}</span></div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Aanvraag</h3>
                        <div><span class="label">Doel</span><br><span class="value">${aanvraag.doel || '-'}</span></div>
                        <div style="margin-top: 10px;"><span class="label">Bedrag</span><br><span class="value">‚Ç¨${aanvraag.bedrag || 100}</span></div>
                        <div style="margin-top: 10px;"><span class="label">Status</span><br><span class="status ${aanvraag.status}">${formatStatus(aanvraag.status)}</span></div>
                    </div>
                    
                    ${aanvraag.eerder_ontvangen ? `
                    <div class="section">
                        <h3>Eerder potje ontvangen</h3>
                        <div class="row">
                            <div><span class="label">Wanneer</span><br><span class="value">${aanvraag.eerder_maand}/${aanvraag.eerder_jaar}</span></div>
                            <div><span class="label">Waarvoor</span><br><span class="value">${aanvraag.vorig_gebruik || '-'}</span></div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="section">
                        <h3>Betaalgegevens</h3>
                        <div class="row">
                            <div><span class="label">IBAN</span><br><span class="value">${aanvraag.iban || '-'}</span></div>
                            <div><span class="label">Tenaamstelling</span><br><span class="value">${aanvraag.tenaamstelling || '-'}</span></div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Administratie</h3>
                        <div><span class="value">${aanvraag.administratie === 'zelf' ? 'Ambassadeur bewaart zelf de administratie (min. 3 jaar)' : 'Ambassadeur levert administratie aan bij kerngroep'}</span></div>
                    </div>
                    
                    ${aanvraag.ervaring ? `
                    <div class="section">
                        <h3>Gedeelde ervaring</h3>
                        <div><span class="value">${aanvraag.ervaring}</span></div>
                    </div>
                    ` : ''}
                    
                    <div class="signature">
                        <div>Handtekening ambassadeur</div>
                        <div>Handtekening kerngroep</div>
                    </div>
                    
                    <div class="footer">
                        Straatambassadeurs Vathorst & Hooglanderveen ‚Äî Van de straat, voor de straat üß°<br>
                        Aanvraag ingediend op: ${formatDateTime(aanvraag.created_at)} | Geprint op: ${new Date().toLocaleString('nl-NL')}
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
        }
        
        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }
        
        // Update Stats
        function updateStats() {
            document.getElementById('stat-nieuw').textContent = aanvragenData.filter(a => a.status === 'nieuw').length;
            document.getElementById('stat-behandeling').textContent = aanvragenData.filter(a => a.status === 'in_behandeling').length;
            document.getElementById('stat-uitgekeerd').textContent = aanvragenData.filter(a => a.status === 'uitgekeerd').length;
            document.getElementById('stat-ambassadeurs').textContent = ambassadeursData.filter(a => a.actief).length;
        }
        
        // Helpers
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('nl-NL', { day: '2-digit', month: '2-digit' });
        }
        
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('nl-NL');
        }
        
        function formatStatus(status) {
            const labels = {
                'nieuw': 'Nieuw',
                'in_behandeling': 'In behandeling',
                'goedgekeurd': 'Goedgekeurd',
                'uitgekeerd': 'Uitgekeerd',
                'afgewezen': 'Afgewezen'
            };
            return labels[status] || status;
        }
        
        function truncate(str, len) {
            if (!str) return '-';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
        
        // Close modal on outside click
        document.getElementById('detail-modal').addEventListener('click', (e) => {
            if (e.target.id === 'detail-modal') closeModal();
        });
        
        // =====================
        // POTJES FUNCTIONALITY
        // =====================
        
        function initPotjesJaarFilter() {
            const select = document.getElementById('potjes-jaar');
            if (!select) return;
            const currentYear = new Date().getFullYear();
            select.innerHTML = '';
            for (let y = currentYear; y >= currentYear - 3; y--) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                select.appendChild(opt);
            }
        }
        
        function populateAmbassadeurDropdown() {
            const select = document.getElementById('potje-ambassadeur');
            if (!select) return;
            const active = ambassadeursData.filter(a => a.actief);
            select.innerHTML = '<option value="">Kies ambassadeur...</option>' +
                active.map(a => `<option value="${a.id}">${a.naam} (${a.straat || ''})</option>`).join('');
        }
        
        function getSelectedYear() {
            const el = document.getElementById('potjes-jaar');
            return el ? parseInt(el.value) || new Date().getFullYear() : new Date().getFullYear();
        }
        
        async function loadPotjes() {
            if (!window.supabaseClient) return;
            const jaar = getSelectedYear();
            
            try {
                // Load toekenningen
                const { data: toekenningen, error: tErr } = await window.supabaseClient
                    .from('potje_toekenningen')
                    .select('*')
                    .eq('jaar', jaar);
                
                if (tErr) {
                    // Table doesn't exist yet
                    if (tErr.code === '42P01' || tErr.message?.includes('does not exist') || tErr.message?.includes('relation')) {
                        potjesTablesExist = false;
                        document.getElementById('potjes-error').classList.remove('hidden');
                        document.getElementById('potjes-content').style.display = 'none';
                        return;
                    }
                    throw tErr;
                }
                
                potjesTablesExist = true;
                document.getElementById('potjes-error').classList.add('hidden');
                document.getElementById('potjes-content').style.display = 'block';
                potjeToekenningenData = toekenningen || [];
                
                // Load uitgaven
                const { data: uitgaven, error: uErr } = await window.supabaseClient
                    .from('potje_uitgaven')
                    .select('*')
                    .eq('jaar', jaar)
                    .order('datum', { ascending: false });
                
                if (uErr) throw uErr;
                potjeUitgavenData = uitgaven || [];
                
                renderPotjes();
            } catch (error) {
                console.error('Potjes laden:', error);
                // Gracefully handle missing tables
                if (error.code === '42P01' || error.message?.includes('does not exist')) {
                    potjesTablesExist = false;
                    document.getElementById('potjes-error').classList.remove('hidden');
                    document.getElementById('potjes-content').style.display = 'none';
                }
            }
        }
        
        function renderPotjes() {
            const jaar = getSelectedYear();
            
            // Build per-ambassadeur overview
            const overview = {};
            ambassadeursData.filter(a => a.actief).forEach(a => {
                overview[a.id] = { naam: a.naam, straat: a.straat || '', budget: 0, besteed: 0 };
            });
            
            // Add budgets from toekenningen
            potjeToekenningenData.forEach(t => {
                if (overview[t.ambassadeur_id]) {
                    overview[t.ambassadeur_id].budget += parseFloat(t.bedrag) || 0;
                }
            });
            
            // Add expenses
            potjeUitgavenData.forEach(u => {
                if (overview[u.ambassadeur_id]) {
                    overview[u.ambassadeur_id].besteed += parseFloat(u.bedrag) || 0;
                }
            });
            
            // Calculate totals
            let totaalBudget = 0, totaalBesteed = 0;
            Object.values(overview).forEach(o => {
                totaalBudget += o.budget;
                totaalBesteed += o.besteed;
            });
            
            document.getElementById('potjes-totaal-budget').textContent = `‚Ç¨${totaalBudget.toFixed(0)}`;
            document.getElementById('potjes-totaal-besteed').textContent = `‚Ç¨${totaalBesteed.toFixed(0)}`;
            document.getElementById('potjes-totaal-resterend').textContent = `‚Ç¨${(totaalBudget - totaalBesteed).toFixed(0)}`;
            
            // Render per-ambassadeur
            const perAmbEl = document.getElementById('potjes-per-ambassadeur');
            const entries = Object.entries(overview).filter(([_, o]) => o.budget > 0 || o.besteed > 0);
            
            if (entries.length === 0) {
                perAmbEl.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 8px; font-size: 0.82rem;">Nog geen potjes toegekend voor ' + jaar + '. Voeg eerst een toekenning toe via de uitgaven of wijs budget toe.</p>';
            } else {
                perAmbEl.innerHTML = entries.map(([id, o]) => {
                    const resterend = o.budget - o.besteed;
                    const pct = o.budget > 0 ? Math.min((o.besteed / o.budget) * 100, 100) : 0;
                    const color = pct >= 100 ? '#ef4444' : pct >= 75 ? '#f59e0b' : '#10b981';
                    return `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--gray-100);">
                            <div style="flex: 1; min-width: 0;">
                                <strong style="font-size: 0.82rem;">${o.naam}</strong>
                                <span style="font-size: 0.72rem; color: var(--gray-400);"> ¬∑ ${o.straat}</span>
                            </div>
                            <div style="width: 80px; background: var(--gray-100); border-radius: 4px; height: 6px; overflow: hidden;">
                                <div style="width: ${pct}%; height: 100%; background: ${color}; border-radius: 4px;"></div>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-600); white-space: nowrap; min-width: 120px; text-align: right;">
                                ‚Ç¨${o.besteed.toFixed(0)} / ‚Ç¨${o.budget.toFixed(0)} <span style="color: ${color};">(‚Ç¨${resterend.toFixed(0)})</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render expenses table
            const tbody = document.getElementById('potjes-uitgaven-tbody');
            if (potjeUitgavenData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 24px; color: var(--gray-400);">Geen uitgaven gevonden voor ' + jaar + '</td></tr>';
            } else {
                tbody.innerHTML = potjeUitgavenData.map(u => {
                    const amb = ambassadeursData.find(a => a.id === u.ambassadeur_id);
                    return `
                        <tr>
                            <td data-label="Datum">${u.datum ? new Date(u.datum).toLocaleDateString('nl-NL') : '-'}</td>
                            <td data-label="Ambassadeur"><strong>${amb ? amb.naam : 'Onbekend'}</strong></td>
                            <td data-label="Omschrijving">${u.omschrijving || '-'}</td>
                            <td data-label="Bedrag" style="font-weight: 600;">‚Ç¨${parseFloat(u.bedrag).toFixed(2)}</td>
                            <td data-label="Acties">
                                <button class="btn-icon btn-danger" onclick="deleteUitgave(${u.id})" title="Verwijderen">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Set date input default
            const datumInput = document.getElementById('potje-datum');
            if (datumInput && !datumInput.value) {
                datumInput.value = new Date().toISOString().split('T')[0];
            }
        }
        
        async function addUitgave() {
            if (!potjesTablesExist) { alert('Potjes tabellen bestaan nog niet. Voer eerst de SQL migration uit.'); return; }
            
            const ambassadeurId = document.getElementById('potje-ambassadeur').value;
            const bedrag = document.getElementById('potje-bedrag').value;
            const omschrijving = document.getElementById('potje-omschrijving').value.trim();
            const datum = document.getElementById('potje-datum').value;
            const jaar = getSelectedYear();
            
            if (!ambassadeurId || !bedrag || !omschrijving || !datum) {
                alert('Vul alle velden in');
                return;
            }
            
            try {
                // Check if ambassadeur has a toekenning for this year, if not create one
                const existing = potjeToekenningenData.find(t => t.ambassadeur_id === parseInt(ambassadeurId));
                if (!existing) {
                    const { error: tErr } = await window.supabaseClient
                        .from('potje_toekenningen')
                        .insert([{ ambassadeur_id: parseInt(ambassadeurId), jaar, bedrag: 100.00, status: 'actief' }]);
                    if (tErr) throw tErr;
                }
                
                const { error } = await window.supabaseClient
                    .from('potje_uitgaven')
                    .insert([{
                        ambassadeur_id: parseInt(ambassadeurId),
                        jaar,
                        bedrag: parseFloat(bedrag),
                        omschrijving,
                        datum
                    }]);
                
                if (error) throw error;
                
                // Reset form
                document.getElementById('potje-bedrag').value = '';
                document.getElementById('potje-omschrijving').value = '';
                
                await loadPotjes();
            } catch (error) {
                console.error('Uitgave toevoegen:', error);
                alert('Er ging iets mis bij het opslaan');
            }
        }
        
        async function deleteUitgave(id) {
            if (!confirm('Weet je zeker dat je deze uitgave wilt verwijderen?')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('potje_uitgaven')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                await loadPotjes();
            } catch (error) {
                console.error('Uitgave verwijderen:', error);
            }
        }
        
        // =====================
        // NOTULEN FUNCTIONALITY
        // =====================
        
        async function loadNotulen() {
            if (!window.supabaseClient) return;
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('notulen')
                    .select('*')
                    .order('datum', { ascending: false });
                
                if (error) {
                    // Table doesn't exist - show static content only
                    if (error.code === '42P01' || error.message?.includes('does not exist')) {
                        notulenData = [];
                        renderNotulen();
                        return;
                    }
                    throw error;
                }
                
                notulenData = data || [];
                renderNotulen();
            } catch (error) {
                console.error('Notulen laden:', error);
                notulenData = [];
                renderNotulen();
            }
        }
        
        function renderNotulen() {
            const listEl = document.getElementById('notulen-list');
            
            if (notulenData.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 16px; font-size: 0.82rem;">Nog geen notulen in de database. Voeg er een toe via het formulier hierboven, of voer eerst de SQL migration uit.</p>';
                return;
            }
            
            listEl.innerHTML = notulenData.map(n => `
                <div class="info-section" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; gap: 8px;">
                    <div style="flex: 1; min-width: 0;">
                        <strong style="font-size: 0.85rem;">üìÑ ${n.titel}</strong><br>
                        <span style="font-size: 0.75rem; color: var(--gray-500);">
                            ${n.datum ? new Date(n.datum).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' }) : ''}
                            ${n.aanwezig ? ' ¬∑ Aanwezig: ' + n.aanwezig : ''}
                        </span>
                        ${n.samenvatting ? `<br><span style="font-size: 0.75rem; color: var(--gray-600); font-style: italic;">${truncate(n.samenvatting, 100)}</span>` : ''}
                    </div>
                    <div style="display: flex; gap: 4px; flex-shrink: 0;">
                        ${n.bestand_url ? `<a href="${n.bestand_url}" target="_blank" class="btn btn-secondary btn-small" download>‚¨áÔ∏è</a>` : ''}
                        <button class="btn-icon btn-danger" onclick="deleteNotulen(${n.id})" title="Verwijderen">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            // Set date input default
            const datumInput = document.getElementById('notulen-datum');
            if (datumInput && !datumInput.value) {
                datumInput.value = new Date().toISOString().split('T')[0];
            }
        }
        
        async function addNotulen() {
            const titel = document.getElementById('notulen-titel').value.trim();
            const datum = document.getElementById('notulen-datum').value;
            const aanwezig = document.getElementById('notulen-aanwezig').value.trim();
            const bestand_url = document.getElementById('notulen-bestand').value.trim();
            const samenvatting = document.getElementById('notulen-samenvatting').value.trim();
            
            if (!titel || !datum) {
                alert('Vul minimaal een titel en datum in');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient
                    .from('notulen')
                    .insert([{ titel, datum, aanwezig, bestand_url: bestand_url || null, samenvatting: samenvatting || null }]);
                
                if (error) {
                    if (error.code === '42P01' || error.message?.includes('does not exist')) {
                        alert('Notulen tabel bestaat nog niet. Voer eerst supabase-migration-002-potjes.sql uit in de Supabase SQL Editor.');
                        return;
                    }
                    throw error;
                }
                
                // Reset form
                document.getElementById('notulen-titel').value = '';
                document.getElementById('notulen-datum').value = '';
                document.getElementById('notulen-aanwezig').value = '';
                document.getElementById('notulen-bestand').value = '';
                document.getElementById('notulen-samenvatting').value = '';
                
                await loadNotulen();
            } catch (error) {
                console.error('Notulen opslaan:', error);
                alert('Er ging iets mis bij het opslaan');
            }
        }
        
        async function deleteNotulen(id) {
            if (!confirm('Weet je zeker dat je deze notulen wilt verwijderen?')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('notulen')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                await loadNotulen();
            } catch (error) {
                console.error('Notulen verwijderen:', error);
            }
        }
    </script>
</body>
</html>
